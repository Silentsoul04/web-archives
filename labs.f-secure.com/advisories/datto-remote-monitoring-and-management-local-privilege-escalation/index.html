<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title> Datto Remote Monitoring and Management Local Privilege Escalation</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/datto-remote-monitoring-and-management-local-privilege-escalation/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/datto-remote-monitoring-and-management-local-privilege-escalation/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/datto-remote-monitoring-and-management-local-privilege-escalation/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1> Datto Remote Monitoring and Management Local Privilege Escalation</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Datto Remote Monitoring and Management </td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>Medium</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td></td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Incorrect Permission Assignment for Critical Resource, Default credentials</td>
          </tr>
        </table>
        
        <h2>Description</h2><p>Datto Remote Monitoring and Management uses UltraVNC to provide a remote takeover functionality. This functionality can be used locally to hijack desktop session of users.</p><p>Datto Remote Monitoring and Management UltraVNC service is configured to listen on localhost only. However any local user can initiate the connection. The VNC connection default password is "password".</p><p>A malicious local user can hijack the desktop session of the other user logged on the same machine. The victim can be logged in either locally or via the Datto RMM "Remote Takeover (VNC)" option.</p><p>The attacker is able to execute code with the privileges of the victim user.</p><h2>Technical Details</h2><p>The following vulnerabilities contribute to the privilege escalation:</p><p><strong>1. CWE-732: Incorrect Permission Assignment for Critical Resource</strong></p><p>Datto Remote Monitoring and Management fails to restrict access to the ultravnc.ini and Gui.exe.config files. Any local user is able to access these files and determine the VNC password in use.</p><p><strong>2. CWE-16: Default VNC credentials</strong></p><p>Datto Remote Monitoring and Management agent by default uses VNC password "password" to access the VNC server. While it is possible to change this password, this does not prevent non-privileged users from discovering the currently used password.</p><p>The discovered vulnerability, enables the attack described here in brief.</p><p>1. The attacker creates a payload that identifies when the administrator user has logged in to the system. Once this condition is identified the payload initiates a VNC connection to localhost to perform malicious actions, such as dropping a powershell script and executing it with the privileges of the logged in user.</p><p>2. The attacker prompts the administrator user to log in. This can be achieved by using social engineering or other methods such as filing a support ticket.</p><p>3. Once the Adminitrator logs on, the malicious payload described in step 1 activates and performs actions as the administrator user, completing the attack.</p><h2>Exploitation steps</h2><div class="p-rich_text_section">In this scenario there are two local users: the regular (unprivileged) user and a local administrator user. The attacker (the regular unprivileged user) performs the following steps:</div><ol class="p-rich_text_list p-rich_text_list__ordered" data-stringify-type="ordered-list" data-indent="0">
<li data-stringify-indent="0">Download vncsnapshot-1.2a-win32.zip from <a class="c-link" rel="noopener noreferrer" href="https://sourceforge.net/projects/vncsnapshot/files/vncsnapshot/1.2a/vncsnapshot-1_2a-win32.zip/download" target="_blank" data-stringify-link="https://sourceforge.net/projects/vncsnapshot/files/vncsnapshot/1.2a/vncsnapshot-1_2a-win32.zip/download" data-sk="tooltip_parent">https://sourceforge.net/projects/vncsnapshot/files/vncsnapshot/1.2a/vncsnapshot-1_2a-win32.zip/download</a></li>
<li data-stringify-indent="0">Extract the vncsnapshot-1.2a-win32.zip archive to “Downloads\vncsnapshot-1.2a”</li>
<li data-stringify-indent="0">In a command prompt “cd Downloads\vncsnapshot-1.2a”</li>
<li data-stringify-indent="0">Execute vncpasswd pass.bin</li>
<li data-stringify-indent="0">Enter “password” twice (without quotes)</li>
<li data-stringify-indent="0">Open notepad and create a file with:</li>
</ol><pre class="p-rich_text_section">@echo off<br>cd “C:\Users\yourusername\Downloads\vncsnapshot-1.2a”<br>vncsnapshot.exe -passwd pass.bin 127.0.0.1 pwned.jpg</pre><ol class="p-rich_text_list p-rich_text_list__ordered" data-stringify-type="ordered-list" data-indent="0">
<li>Save the file as C:\Users\yourusername\Desktop\poc.bat</li>
<li data-stringify-indent="0">Open “Task Scheduler”</li>
<li data-stringify-indent="0">Select “Create Task...”</li>
<li data-stringify-indent="0">Give the task a name, for example “vnc poc”</li>
<li data-stringify-indent="0">In “Triggers” tab, select “New…”</li>
<li data-stringify-indent="0">On “Advanced settings” select “Repeat task every:” and select “5 minutes” and “Indefinitely”</li>
<li data-stringify-indent="0">Click “Ok”</li>
<li data-stringify-indent="0">In “Actions” tab click “New…”</li>
<li data-stringify-indent="0">“Browse…” and select the “C:\Users\yourusername\Desktop\poc.bat”</li>
<li data-stringify-indent="0">Click “Ok”</li>
<li data-stringify-indent="0">In “Conditions” tab unselect “Start the task only if the computer is on AC power”</li>
<li data-stringify-indent="0">Click “Ok”</li>
<li data-stringify-indent="0">Enter current user password if/when prompted</li>
</ol><div class="p-rich_text_section">The proof of concept exploit has been set up now. Next:</div><ol class="p-rich_text_list p-rich_text_list__ordered" data-stringify-type="ordered-list" data-indent="0">
<li data-stringify-indent="0">Switch user and log on as admin user</li>
<li data-stringify-indent="0">Wait for 6 minutes on the admin desktop</li>
<li data-stringify-indent="0">Switch back to the low privileged user</li>
<li data-stringify-indent="0">Check C:\Users\yourusername\Downloads\vncsnapshot-1.2a\pwned.jpg for a screenshot of the admin’s desktop.</li>
</ol><p><span>It should be noted that this PoC is a bit off with the timing: You might get a screenshot of the user’s own desktop if you’re unlucky. This is </span>a restriction of this PoC alone<span>, a real attack would use alternate exploitation methods. Note that the exploit could perform </span>any action as the administrator user over the VNC. These actions would need to be scripted to perform operations over the emulated keyboard and mouse, such as opening the cmd.exe or powershell.exe to inject malicious scripts / commands. A simpler exploit would be to add a new local admin user that the attacker could then use once successfully created. <span><br></span></p><h2>Remedial Action</h2><p>Upgrade to the Datto Remote Monitoring and Management version 9.2.0 or later and opt to not use VNC in the environment.</p><p>If no upgrade is possible for some reason you can try disabling the "uvnc_service" manually as a mitigation.</p><h2>Acknowledgements</h2><p>A somewhat similar vulnerability was reported to Datto earlier by Michael Jones / Inevat.</p><h2>Timeline</h2><table>
<tbody>
<tr>
<td>22/12/2020</td>
<td>Discovered the vulnerability</td>
</tr>
<tr>
<td>23/12/2020</td>
<td>Wrote the first draft of this advisory</td>
</tr>
<tr>
<td>24/12/2020</td>
<td>Reported the vulnerability via Datto's VDP</td>
</tr>
<tr>
<td>28/12/2020</td>
<td>Datto indicated that the issue was already previously reported. Requested details about expected disclosure date</td>
</tr>
<tr>
<td>01/02/2021</td>
<td>Datto RRM 9.1.0 release with "Remove Datto RMM UltraVNC Service Monitor": "Monitor to disable Datto RMM's VNC implementation for those who prefer not to use it. Presented as an option."</td>
</tr>
<tr>
<td>17/2/2021</td>
<td>Datto RRM 9.2.0 announced with "VNC management settings": "We have added the ability to control whether VNC is installed on Datto RMM devices. This can be controlled in Account Settings or on a per-site basis, providing flexibility when VNC is not desired in certain client environments."</td>
</tr>
<tr>
<td>26/2/2021</td>
<td>Again requested details of the coordinated disclosure timeline and CVE<br> assignment</td>
</tr>
<tr>
<td>8/3/2021</td>
<td>Provided a proof of concept exploit to Datto as requested</td>
</tr>
<tr>
<td>10/3/2021</td>
<td>Datto confirmed the vulnerability with CVSS score 7.3 (High)</td>
</tr>
<tr>
<td>17/5/2021</td>
<td>Public disclosure</td>
</tr>
</tbody>
</table>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/datto-remote-monitoring-and-management-local-privilege-escalation/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/datto-remote-monitoring-and-management-local-privilege-escalation/&text= Datto Remote Monitoring and Management Local Privilege Escalation" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/datto-remote-monitoring-and-management-local-privilege-escalation/&title= Datto Remote Monitoring and Management Local Privilege Escalation" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/datto-remote-monitoring-and-management-local-privilege-escalation/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
