<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Das U-Boot Verified Boot Bypass</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/das-u-boot-verified-boot-bypass/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/das-u-boot-verified-boot-bypass/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/das-u-boot-verified-boot-bypass/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type">Advisories</span>
      <h1>Das U-Boot Verified Boot Bypass</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Das U-Boot</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>Medium</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2020-10648</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Security bypass</td>
          </tr>
        </table>
        
        <h2>Introduction</h2><p>Das U-Boot typically is employed as a second-stage boot loader responsible for loading the Linux operating system's kernel and related images and passing control on to the OS. The boot loader is also responsible of verifying the integrity and authenticity of the loaded images to ensure only authentic software is allowed to run. U-Boot's <a href="https://github.com/u-boot/u-boot/blob/master/doc/uImage.FIT/verified-boot.txt">verified</a> <a href="https://github.com/u-boot/u-boot/blob/master/doc/uImage.FIT/signature.txt">boot</a> feature is used to achieve this. This method only applies to the flattened image tree (FIT) image format.</p><p>The FIT image is based on a previously developed device tree format used in both U-Boot and the Linux kernel to store and pass configuration information. An example image tree source (the text format used to generate FIT images) from the documentation is reproduced below to illustrate the concept:</p><pre>/ {<br>    images {<br>        kernel-1 {<br>            data = &lt;data for kernel1&gt;<br>            hash-1 {<br>                algo = "sha1";<br>                value = &lt;...kernel hash 1...&gt;<br>            };<br>        };<br>        kernel-2 {<br>            data = &lt;data for kernel2&gt;<br>            hash-1 {<br>                algo = "sha1";<br>                value = &lt;...kernel hash 2...&gt;<br>            };<br>        };<br>        fdt-1 {<br>            data = &lt;data for fdt1&gt;;<br>            hash-1 {<br>                algo = "sha1";<br>                value = &lt;...fdt hash 1...&gt;<br>            };<br>        };<br>        fdt-2 {<br>            data = &lt;data for fdt2&gt;;<br>            hash-1 {<br>                algo = "sha1";<br>                value = &lt;...fdt hash 2...&gt;<br>            };<br>        };<br>    };<br>    configurations {<br>        default = "conf-1";<br>        conf-1 {<br>            kernel = "kernel-1";<br>            fdt = "fdt-1";<br>            signature-1 {<br>                algo = "sha1,rsa2048";<br>                value = &lt;...conf 1 signature...&gt;;<br>            };<br>        };<br>        conf-2 {<br>            kernel = "kernel-2";<br>            fdt = "fdt-2";<br>            signature-1 {<br>                algo = "sha1,rsa2048";<br>                value = &lt;...conf 1 signature...&gt;;<br>            };<br>        };<br>    };<br>};</pre><p>This image tree source describes two kernels with two flattened device tree blobs (FDTs) as well as two configurations denoting which images are to be used together. The complete configuration may also include other images e.g. RAM disks. Hash values for individual images are computed during image build.</p><p>When an image is signed using the <strong>mkimage</strong> tool provided with U-Boot, the image is modified by adding several properties to corresponding signature nodes, specifically <strong>hashed-strings</strong>, <strong>hashed-nodes</strong>, <strong>timestamp</strong>, <strong>signer-version</strong>, <strong>signer-name</strong>, and <strong>value</strong>. The <strong>value</strong> property holds the actual signature, while the <strong>hashed-strings</strong> and <strong>hashed-nodes</strong> properties represent the elements that were used to compute the signed hash value. For example:</p><pre>conf@1 {<br>  description = [REMOVED];<br>  kernel = "kernel@1";<br>  fdt = "fdt@1";<br>  ramdisk = "ramdisk@1";<br>  signature@1 {<br>    hashed-strings = [00 00 00 00 00 00 00 8e];<br>    hashed-nodes = "/", "/configurations/conf@1", "/images/fdt@1", "/images/fdt@1/hash@1", "/images/kernel@1", "/images/kernel@1/hash@1", "/images/ramdisk@1", "/images/ramdisk@1/hash@1";<br>    timestamp = [5d cb 49 dc];<br>    signer-version = "2019.07";<br>    signer-name = "mkimage";<br>    value = [03 d9 d7 e8 5a cf ..];<br>    algo = "sha256,rsa4096";<br>    key-name-hint = [REMOVED];<br>    sign-images = "fdt", "kernel", "ramdisk";<br>  };<br>};</pre><p>The string block data starting from offset 0 to offset 0x8E was included in the hash computation along with enumarated tree nodes, which produces the given RSA signature.</p><h2>Description</h2><p>It was found that U-Boot does not verify the contents of <strong>hashed-nodes</strong> correlate with the sub-images required to be loaded by the configuration, specified e.g. in the <strong>kernel</strong>, <strong>fdt</strong>, and <strong>ramdisk</strong> configuration properties. This allows us to craft another configuration with the same signature node but referencing a different sub-image(s):</p><pre>conf@2 {<br>  description = "Super 1337 Configuration";<br>  kernel = "kernel@2";<br>  fdt = "fdt@1";<br>  ramdisk = "ramdisk@1";<br>  signature@1 {<br>    hashed-strings = [00 00 00 00 00 00 00 8e];<br>    hashed-nodes = "/", "/configurations/conf@1", "/images/fdt@1", "/images/fdt@1/hash@1", "/images/kernel@1", "/images/kernel@1/hash@1", "/images/ramdisk@1", "/images/ramdisk@1/hash@1";<br>    timestamp = [5d cb 49 dc];<br>    signer-version = "2019.07";<br>    signer-name = "mkimage";<br>    value = [03 d9 d7 e8 5a cf ..];<br>    algo = "sha256,rsa4096";<br>    key-name-hint = [REMOVED];<br>    sign-images = "fdt", "kernel", "ramdisk";<br>  };<br>};</pre><p>As by design only certain parts of the FIT image are hashed, it is possible to insert arbitrary FIT nodes after configurations have been signed without invalidating any signatures, adding both arbitrary configurations as well as arbitrary sub-images. Note that this fact is explicitly documented. It is also possible to change the default property of the configurations node to suggest the crafted configuration to be chosen.</p><h2>Impact</h2><p>An attacker having a properly signed FIT image is able to craft arbitrary FIT images that would pass signature validation, resulting in booting and execution of untrusted code.</p><p>The exploitation relies on the fact that the crafted configuration will be chosen to be booted. This may occur, for example, when the attacker is able to modify the <strong>default</strong> property of the <strong>configurations</strong> node and the setup does not explicitly choose to boot a specific configuration. Consequently, one way of mitigating the issue is to explicitly specify the configuration name as part of the <strong>bootm</strong> command arguments, for example:</p><pre>bootm ${loadaddr}#conf@1 - ${fdtaddr}</pre><h2>Affected versions</h2><p>U-Boot versions 2018.03 and 2020.01 were verified to be affected. Versions prior to 2018.03 may be affected as well.</p><h2>Solution</h2><p>Apply patches or update to a fixed version when available.</p><p>Preliminary patches <a href="https://lists.denx.de/pipermail/u-boot/2020-March/403409.html" target="_blank">have been posted to the mailing list</a> for review.</p><h2>Detailed timeline</h2><table><tbody><tr><td>Date</td>
<td> Summary</td>
</tr><tr><td>2020-01-22</td>
<td> Discovery of the issue.</td>
</tr><tr><td>2020-01-24</td>
<td>Details sent to maintainers Tom Rini and Simon Glass.</td>
</tr><tr><td>2020-02-26</td>
<td>Patches provided for review by Simon Glass</td>
</tr><tr><td>2020-03-11</td>
<td>Release date agreed to be March 18.</td>
</tr><tr><td>2020-03-17</td>
<td>CVE assignment.</td>
</tr><tr><td>2020-03-18</td>
<td>Public release.</td>
</tr></tbody></table>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/das-u-boot-verified-boot-bypass/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/das-u-boot-verified-boot-bypass/&text=Das U-Boot Verified Boot Bypass" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/das-u-boot-verified-boot-bypass/&title=Das U-Boot Verified Boot Bypass" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/das-u-boot-verified-boot-bypass/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
