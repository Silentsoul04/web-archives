<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>AutoCad .NET Deserialisation Vulnerability</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/autocad-net-deserialisation-vulnerability/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/autocad-net-deserialisation-vulnerability/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/autocad-net-deserialisation-vulnerability/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>AutoCad .NET Deserialisation Vulnerability</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>AutoCad</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>Medium</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2019-7361</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Code Execution</td>
          </tr>
        </table>
        
        <h1>Description</h1><p>The Action Macro functionality of AutoDesk’s AutoCad software suite is vulnerable to code execution due to improper validation of user input passed to a deserialization call.</p><p>AutoCad provides the ability to automate a set of tasks by recording the user performing those tasks and replaying them later. This functionality is called Action Macros. Before playing an Action Macro, the list of actions performed are presented to the user, as shown in the next figure.</p><p><img class="leftAlone" title="" src="assets/Uploads/donuts-2.png" alt="donuts 2" width="332" height="510"></p><p>This recording will create a number of “DONUT” objects within the current drawing.</p><p>Once an Action Macro has been recorded, it is saved to the user’s “Actions” directory as a .actm file. A snippet of the underlying data of the Action Macro file for the above recording is shown below:</p><p><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzYwMCwyODdd/hex-dump2.png" alt="hex dump2" width="600" height="287"></p><p>This data is made up of a number of .NET serialized objects. Highlighted in red is the length of the first object (of type AutoDesk.AutoCad.MacroRecorder.MacroNode). The green outline highlights the actual object, and the blue is the beginning of the next object.</p><p>It should be noted that this data is deserialized to allow the user to view the tree of actions within a recording prior to the user clicking “play”. The vulnerability ultimately lies in AcMR.dll, specifically the method AutoDesk.AutoCad.MacroRecorder.BaseNode.Load:</p><pre>public static INode Load(Stream stream)<br> {<br> if (!DebugUtil.Verify(stream != null))<br> return (INode) null;<br> object obj = MacroManager.Formatter.Deserialize(stream); <strong>(2)</strong><br> if (DebugUtil.Verify(obj is INode)) <strong>(3)</strong><br> return obj as INode;<br> return (INode) null;<br> }
public void Save(Stream stream)<br> {<br> if (!DebugUtil.Verify(stream != null))<br> return;<br> MacroManager.Formatter.Serialize(stream, (object) this); <strong>(1)</strong><br> }</pre><ul><li>At (1) the object is saved using MacroManager.Formatter’s Serialize method – this occurs when an Action Macro is saved.</li>
<li>At (2), the user input stream is Deserialized prior to being checked as a valid Inode object at (3). These actions occur when the Action Macro is loaded into memory.</li>
</ul><p>The MacroManager.Formatter.Deserialize method is a wrapper to the .NET BinaryFormatter function:</p><pre>public static IFormatter Formatter<br> {<br> get<br> {<br> if (MacroManager.m_formatter == null)<br> {<br> MacroManager.m_formatter = (IFormatter) new BinaryFormatter();<br> MacroManager.m_formatter.Binder = (SerializationBinder) new MacroManager.TypeRedirectionBinder();<br> }<br> return MacroManager.m_formatter;<br> }<br> }</pre><p>A malicious user is able to gain code execution by replacing legitimate serialized objects in an Action Macro file. As a proof of concept, the ysoserial.net tool was used to generate a series of .NET gadgets that, when deserialised, would cause a calculator to be opened.</p><p>The command used for this proof of concept was:</p><pre>ysoserial.exe -o raw -g TypeConfuseDelegate -c "calc.exe"  -f BinaryFormatter &gt; poc_calc_action_macro.actm</pre><p>Code execution occurs when a user attempts to view the actions within an Action Macro, this occurs directly prior to replaying it, as demonstrated in the next figure. Note that the Action Macro is never “played”.</p><p><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzYwMCwzNzFd/calc-popped-actm2.png" alt="calc popped actm2" width="600" height="371"></p><h1>Impact</h1><p>This vulnerability is of medium risk to end users. Code execution occurs in the context of the current user, no extra privileges are gained.</p><p>The potential attack vector could be through phishing of end users, whereby they are coerced into playing malicious Action Macros believing them to be legitimate. The most likely scenario could involve a malicious actor sharing an ActionMacro file online that supposedly solves a community problem.</p><h1>Solution</h1><p>As of February 1st 2019 AutoDesk have released a patch migitating this vulnerability. Users are advised to update AutoCad to the most recent version available.</p><p>AutoDesk have also produced  following advisory pertaining to this vulnerability as well as a number of others [2].</p><h1>References</h1><p>[1] ysoserial.net - https://github.com/pwntester/ysoserial.net/tree/master/ysoserial</p><p>[2] AutoDesk Advisory - https://www.autodesk.com/trust/security-advisories/adsk-sa-2019-0001</p><p> </p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/autocad-net-deserialisation-vulnerability/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/autocad-net-deserialisation-vulnerability/&text=AutoCad .NET Deserialisation Vulnerability" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/autocad-net-deserialisation-vulnerability/&title=AutoCad .NET Deserialisation Vulnerability" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/autocad-net-deserialisation-vulnerability/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
