<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Microchip AT91Bootstrap Code Authentication Issues</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/microchip-at91bootstrap/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/microchip-at91bootstrap/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/microchip-at91bootstrap/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Microchip AT91Bootstrap Code Authentication Issues</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Microchip AT91bootstrap</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>Medium</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2020-11683, CVE-2020-11684</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Information disclosure, Side channel</td>
          </tr>
        </table>
        
        <h2>Background</h2><p>The <a href="https://github.com/linux4sam/at91bootstrap" target="_blank">AT91Bootstrap project</a> is the 2nd level bootloader for certain families of Microchip (formerly Atmel) microprocessors (aka AT91). It provides a set of algorithms to manage the hardware initialization, download the next boot stage from specified media, authenticate it, and start it.</p><p>Two issues were identified in the code authentication functionality which allow attackers with physical access to disclose encryption keys and conduct side channel analysis attacks.</p><h3>Sensitive data remains in memory after AT91bootstrap hands control to application</h3><p>One of the main tasks of the AT91bootstrap component is to authenticate and decrypt the next stage, for example, the U-Boot loader. For that, a set of hardcoded credentials is used, consisting of a key and an initialization vector (IV) for decryption as well as a CMAC key for authentication.</p><p>It was found that these sensitive keys, which are part of AT91bootstrap image, are not completely wiped from memory after authentication and decryption is complete; only a copy located in stack variables is <a href="https://github.com/linux4sam/at91bootstrap/blob/v3.9.1/driver/secure.c#L116" target="_blank">wiped</a>, however the original values persist as part of the code segment.</p><pre>int secure_decrypt(void *data, unsigned int data_length, int is_signed)<br>{<br>...<br>    /* Init keys */<br>    init_keys(&amp;key_size, cipher_key, cmac_key, iv);<br><br>    /* Init periph */<br>    at91_aes_init();<br>...<br>exit:<br>    /* Reset periph */<br>    at91_aes_cleanup();<br><br>    /* Reset keys */<br>    memset(cmac_key, 0, sizeof(cmac_key));<br>    memset(cipher_key, 0, sizeof(cipher_key));<br>    memset(iv, 0, sizeof(iv));<br><br>    return rc;</pre><p>This allows the application to intercept these values when control is received from the bootstrap.</p><p>To verify this finding, the bootstrap was built with recognizable keys (words with equal 4-bit nibbles set to incrementing value for each word). U-Boot was used as the application and configured to provide a command console. After the boot process was stopped, it was possible to dump memory where the bootstrap code is located, and with that, extract key material. The following abbreviated console capture shows how this was done.</p><div>
<div>
<pre class="CodeBlock-forblocksoftext">RomBOOT<br>Secure Boot Mode<br><br>[ REMOVED FOR BREVITY ]<br>AT91Bootstrap 3.8.10 (Fri Jan 31 04:59:36 UTC 2020)<br>[ REMOVED FOR BREVITY ]<br>U-Boot 2017.03-linux4sam_5.8 (Jan 26 2020 - 14:16:26 +0000)<br>[ REMOVED FOR BREVITY ]<br>Hit any key to stop autoboot:  0<br>=&gt; md 00205150 14<br>00205150: aaaaaaaa 77777777 88888888 99999999    ....wwww........<br>00205160: 11111111 33333333 44444444 dddddddd    ....3333DDDD....<br>[REMOVED]</pre>
</div>
<p>The key material can be recognized in the dumped data. Analysis showed the addresses belong to the code section; the address is provided directly in the example above for illustrative purposes.</p>
<h4>Impact</h4>
<p>An attacker able to compromise the application stage, for example by forging the CMAC value as described below, gains access to cryptographic material used to encrypt and authenticate the application stage. This results in a compromise of the expected security guarantees and the ability to forge arbitrary applications.</p>
<h3>Timing side channel exists when verifying CMAC</h3>
<p>Apart from direct information leakage, for example, due to software disclosing sensitive data directly, it is possible to attack software using side channels which leak information indirectly. Timing side channel is one such kind which is caused due to time variations in certain algorithms depending on data being processed.</p>
<p>The AT91boostrap code uses cipher-based message authentication code (CMAC) to authenticate the next stage before handing control over. By inspecting the source code, it was found that the AT91bootstrap loader employs such a time-varying operation in security critical code which verifies CMAC validity. This allows an attacker to dramatically speed up brute force attacks.</p>
<p>The following <a href="https://github.com/linux4sam/at91bootstrap/blob/v3.9.1/driver/secure.c#L106" target="_blank">code excerpt</a> from the official source code tree illustrates the issue:</p>
<pre>int secure_decrypt(void *data, unsigned int data_length, int is_signed)<br>{<br>…<br><br>    /* Check signature if required */<br>    if (is_signed) {<br>        /* Compute the CMAC */<br>        if (at91_aes_cmac(data_length, data, computed_cmac,<br>                  key_size, cmac_key))<br>            goto exit;<br><br>        /* Check the CMAC */<br>        fixed_length = at91_aes_roundup(data_length);<br>        cmac = (const unsigned int *)((char *)data + fixed_length);<br>        if (memcmp(cmac, computed_cmac, AT91_AES_BLOCK_SIZE_BYTE))<br>            goto exit;<br>    }<br>…</pre>
<p>The memcmp() C library function does not provide any guarantee regarding its performance or fitness for cryptographic use, and its use in sensitive contexts is generally discouraged. <span style="mso-fareast-language: DA;">The function's execution time strongly depends on how much data compares equal, allowing making precise guesses whether a given CMAC byte is correct or not. To provide an example, assume the attacker knows the first N bytes of a CMAC value for the given text; they take time measurements while trying all 256 values for the N+1'th byte. For the correct guess, execution time will be slightly longer; this value is accepted as correct and the procedure is repeated for the next byte.</span></p>
<h4><span style="mso-fareast-language: DA;">Impact</span></h4>
<p><span style="mso-fareast-language: DA;">By timing the response, an attacker with physical access is able to conduct efficient attacks against the CMAC verification step and forge CMAC values for manipulated application images. While the images are encrypted, am attack may be conducted against AES-CBC by freely manipulating one block of encrypted data using XOR.<br></span></p>
<h2><span style="mso-fareast-language: DA;">Affected versions</span></h2>
<p>The issues were identified in AT91bootstrap version 3.9.1. Prior versions may also be affected.</p>
<h2>Solution</h2>
<p>Update to version 3.9.2 when available or apply patches provided by the vendor.</p>
<h2>Credit</h2>
<p>The issues were discovered by Dmitry Janushkevich of F-Secure Hardware Security team.</p>
<h2>Detailed timeline</h2>
<table><tbody><tr><td>Date</td>
<td>Summary</td>
</tr><tr><td>2020-02-07</td>
<td>First contact</td>
</tr><tr><td>2020-02-07</td>
<td>Details provided to Microchip</td>
</tr><tr><td>2020-02-25</td>
<td>F-Secure requests status update</td>
</tr><tr><td>2020-02-27</td>
<td>Microchip informs of fixes being prepared for the next software release.</td>
</tr><tr><td>2020-03-30</td>
<td>Without notifying F-Secure, Microchip publishes the patches</td>
</tr><tr><td>2020-03-31</td>
<td>Microchip provides the patches for review</td>
</tr><tr><td>2020-04-06</td>
<td>F-Secure discovers the patches are public</td>
</tr><tr><td>2020-04-10</td>
<td>CVEs assigned by MITRE</td>
</tr><tr><td>2020-04-20</td>
<td>Public release</td>
</tr></tbody></table><p> </p>
</div>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/microchip-at91bootstrap/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/microchip-at91bootstrap/&text=Microchip AT91Bootstrap Code Authentication Issues" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/microchip-at91bootstrap/&title=Microchip AT91Bootstrap Code Authentication Issues" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/microchip-at91bootstrap/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
