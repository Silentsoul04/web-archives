<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Xiaomi Redmi 5 Plus Second Space Password Bypass</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/xiaomi-second-space/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="Xiaomi Redmi 5 Plus Second Space Password Bypass">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/xiaomi-second-space/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Xiaomi Redmi 5 Plus Second Space Password Bypass">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/xiaomi-second-space/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Xiaomi Redmi 5 Plus Second Space Password Bypass</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Xiaomi Redmi 5 Plus </td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>Medium</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td></td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Authentication Bypass</td>
          </tr>
        </table>
        
        <h2>Introduction</h2><p>Xiaomi Second Space replaces Android User Profiles on MIUI devices. It allows for a Primary (admin) and a Second user to switch profiles via an icon on the homescreen or from the lock screen. Both user spaces can be protected by a PIN or password.<br><br>A method was discovered in the Xiaomi MIUI System, that allows a user to switch between spaces without providing a password or PIN. This requires Second Space and Password / PIN screen lock to be enabled along with USB debugging.</p><p>The vulnerability is triggered by an ADB command that sends an intent to start the SwitchUserService service with a flag that bypasses the password prompt. As a result, the user can immediately switch space without knowing the password.</p><p>The issue was discovered in a Redmi 5 Plus device, but it has been confirmed to affect several of the latest MIUI versions.</p><h2>Proof of Concept</h2><p>From a brand new Redmi 5 plus device:</p><ol><li>
<p>Set up "Second Space" feature, and set a Lock Screen Password or PIN if prompted for one, from <strong>Settings &gt; Second Space</strong> </p>
</li>
<li>
<p>Activate Developer Options by navigating to <strong>Settings &gt; About Phone</strong> and tapping 7 times on <strong>MIUI Version</strong></p>
</li>
<li>
<p>Enable USB Debugging from <strong>Settings &gt; Additional Settings &gt; Developer Options &gt; USB Debugging</strong></p>
</li>
<li>
<p>Connect USB cable and authorise Computer once prompted</p>
</li>
<li>
<p>Type the following commands to get Second Space user's ID and then switch to it, bypassing the Password / PIN prompt</p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-def">$ SECOND_USER</span><span class="cm-operator">=</span><span class="cm-quote">`adb shell pm list users | grep -o "{[0-9]*" | tr -d '{' | tail -n 1`</span></span><br><span><span class="cm-def">$ adb</span> shell am start-service <span class="cm-attribute">--ez</span> params_check_password False <span class="cm-attribute">--ei</span> params_target_user_id <span class="cm-def">$SECOND_USER</span> <span class="cm-attribute">-a</span> com.miui.xspace.TO_CHANGE_USER</span></pre>
<p>to switch from Second Space to Primary without providing the password just change to</p>
<pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-def">$ adb</span> shell am start-service <span class="cm-attribute">-e</span> params_check_password False <span class="cm-attribute">-e</span> params_target_user_id <span class="cm-number">0</span> <span class="cm-attribute">-a</span> com.miui.xspace.TO_CHANGE_USER</span> </pre>
</li>
</ol><p>The process <span class="md-plain">is demonstrated in the video attached below (full screen viewing is recommended).</span></p><p><video width="648px" height="361px" controls="controls"><source src="assets/Uploads/demo3.mp4" type="video/mp4"><object width="648px" height="361px" data="framework/thirdparty/tinymce/plugins/media/moxieplayer.swf" type="application/x-shockwave-flash"><param name="src" value="framework/thirdparty/tinymce/plugins/media/moxieplayer.swf"><param name="flashvars" value="url=/assets/Uploads/demo3.mp4&amp;poster=/"><param name="allowfullscreen" value="true"><param name="allowscriptaccess" value="true"></object> Your browser does not support the video tag. </source></video></p><p>The following actions are recorded:</p><ol><li>
<p>(00:02) Switch to the second space, PIN entry is requested and provided when the screen is blacked, visible through the "Settings" activity briefly shown</p>
</li>
<li>
<p>(00:13) Switch back to the primary space, PIN entry is requested and provided. Again, the "Settings" activity is briefly shown</p>
</li>
<li>
<p>(00:29) Switch to the second space without PIN, no "Settings" popup</p>
</li>
<li class="md-list-item">
<p>(00:43) Switch back to the primary space altering the params_target_user_id, without PIN no "Settings" popup</p>
</li>
<li>
<p>(01:23) Switch again to the second space to show the PIN entry requirement in the relevant Settings</p>
</li>
</ol><h2>Technical Details</h2><p><span class="md-plain md-expand">The system application / package responsible for most Second Space functionality is </span><span>com.miui.securitycore</span><span class="md-plain">. Static analysis of the "Switching between spaces" option in the settings seen below, points us to the </span><span>SecondSpaceSettingsFragment</span><span class="md-plain"> class which implements this switch with a call to the </span><span>switchToOwnerSpace()</span><span class="md-plain"> method. This in turn starts the </span><span>com.miui.securityspace.service.</span><span><strong><span>SwitchUserService</span></strong></span><span class="md-plain md-expand"> service with an intent.</span></p><table style="width: 100%;"><tbody><tr><td><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzI3MSw1NDJd/2nd-space-settings-hl.png" alt="2nd space settings hl" width="271" height="542"></td>
<td><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzY4NCw1NDJd/code7.png" alt="code7" width="684" height="542"></td>
</tr></tbody></table><p><span class="md-plain md-expand">Inside this service's implementation, the </span>startCommand()<span class="md-plain"> override calls </span>checkPasswordBeforeSwitch()<span class="md-plain"> that processes the intent and then calls </span>SpaceManager.switchUser()<span class="md-plain"> from where the switch process is kicked-off.</span></p><p class="md-end-block md-p"><span class="md-plain">The vulnerability lies in the way the password requirement is enforced inside </span><span>checkPasswordBeforeSwitch()</span><span class="md-plain md-expand">, as the existence of a boolean extra is sufficient to skip the prompt. This means that one can bypass password entry when sending the service start intent with the </span><span>params_check_password</span><span class="md-plain"> extra set to False. This can be achieved using the ADB shell, without need for root access, by issuing the following command:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-def">$ am</span> start-service <span class="cm-attribute">--ez</span> params_check_password False <span class="cm-attribute">--ei</span> params_target_user_id <span class="cm-number">10</span> <span class="cm-attribute">-a</span> com.miui.xspace.TO_CHANGE_USER</span></pre><p class="md-end-block md-p"><span class="md-plain">The above command also works in reverse, i.e. switching from second to primary space by specifying the </span><span>params_target_user_id</span><span class="md-plain"> integer extra to 0. </span></p><p class="md-end-block md-p"><span class="md-plain">Closer examination of the application's </span><span>AndroidManifest.xml</span><span class="md-plain"> reveals the Service is not declared </span><span>private</span><span class="md-plain"> nor </span><span>exported=false</span><span class="md-plain">. However, if not explicitly set, the Service is exported by default due to the </span><span class=" md-link"><span class="md-plain"><a href="https://developer.android.com/guide/topics/manifest/service-element.html#exported">existence of intent-filters</a>, as seen in the following extract from the manifest:</span></span><span class="md-plain"><br></span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded"><span><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">service</span> <span class="cm-attribute">android:name</span>=<span class="cm-string">"com.miui.securityspace.service.SwitchUserService"</span></span><br><span>         <span class="cm-attribute">android:permission</span>=<span class="cm-string">"android.permission.INTERACT_ACROSS_USERS"</span></span><br><span>         <span class="cm-attribute">android:process</span>=<span class="cm-string">"com.miui.securitycore.remote"</span><span class="cm-tag cm-bracket">&gt;</span></span><br><span>    <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">intent-filter</span><span class="cm-tag cm-bracket">&gt;</span></span><br><span>        <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">action</span> <span class="cm-attribute">android:name</span>=<span class="cm-string">"com.miui.xspace.TO_CHANGE_USER"</span><span class="cm-tag cm-bracket">/&gt;</span></span><br><span>    <span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">intent-filter</span><span class="cm-tag cm-bracket">&gt;</span></span><br><span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">service</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><p>Therefore, the security of the Service relies on the permission required to start it, as most applications holding the INTERACT_ACROSS_USERS permission are system ones. This permission however is also held by the <span>shell</span><span class="md-plain"> user, which is the access level a normal, non-root ADB shell provides.</span></p><h2>Credit</h2><p>The issue was discovered by Leonidas Tsaousis (<a title="Twitter" href="https://twitter.com/LAripping" target="_blank">@laripping</a>) of F-Secure Consulting.</p><h2>Timeline</h2><table><thead><tr><td>Date</td>
<td>Summary</td>
</tr></thead><tbody><tr><td>25/02/2020</td>
<td>Issue reported to Xiaomi through HackerOne </td>
</tr><tr><td>26/02/2020</td>
<td>Bug triaged and bounty was rewarded.</td>
</tr><tr><td>04/05/2020</td>
<td>Contacted Xiaomi via HackerOne, requesting status update</td>
</tr><tr><td>06/05/2020</td>
<td>Xiaomi replied stating the issue has been fixed and would be tested in development version released by the end of the week </td>
</tr><tr><td>09/05/2020</td>
<td>Xiaomi states that the issue is fixed in development version 5.09</td>
</tr><tr><td>28/05/2020</td>
<td>F-Secure release advisory</td>
</tr></tbody></table><p> </p><p> </p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/xiaomi-second-space/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/xiaomi-second-space/&text=Xiaomi Redmi 5 Plus Second Space Password Bypass" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/xiaomi-second-space/&title=Xiaomi Redmi 5 Plus Second Space Password Bypass" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/xiaomi-second-space/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
