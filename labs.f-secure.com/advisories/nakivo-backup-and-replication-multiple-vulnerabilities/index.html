<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Nakivo Backup &amp; Replication - Multiple vulnerabilities</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/nakivo-backup-and-replication-multiple-vulnerabilities/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/nakivo-backup-and-replication-multiple-vulnerabilities/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/nakivo-backup-and-replication-multiple-vulnerabilities/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Nakivo Backup &amp; Replication - Multiple vulnerabilities</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Nakivo Backup &amp; Replication versions below 10.3.0.n54125</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2020-15850, CVE-2020-15851</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Lack of access control, Local privilege escalation</td>
          </tr>
        </table>
        
        <h1>Intro</h1><p>NAKIVO Backup &amp; Replication software provides image-based, application-aware, incremental backup and replication features. Commonly used to backup physical and virtual machines to a NAS for example. According to the vendor website and marketing materials, they boast that big brand organisations such as Verifone, Coca-Cola, Honda, Radisson, DHL et al trust NAKIVO and use their software. F-Secure Labs have identified two security issues with the NAKIVO Backup &amp; Replication software; "Local privilege escalation in Nakivo Director on Linux (CVE-2020-15850)" &amp; "Lack of access control in Nakivo Transporter (CVE-2020-15851)". These vulnerabilities can be leveraged to escalate privileges as well as gain unauthenticated remote access to backups.</p><p>The NAKIVO Backup &amp; Replication software consists of three main components:</p><ul>
<li>Director - a central management service providing a web interface (that by default) listens on TCP port 4443 (HTTPS).</li>
<li>Transporter - a network service responsible for performing all of the backup, data protection and recovery tasks and listens on TCP port 9446 (TLS).</li>
<li>Backup repository - data folder on local or remote storage (NAS).</li>
</ul><p>All components can be installed on a single machine or can be distributed across multiple machines and geographical locations. Two security vulnerabilities were identified in the Director and Transporter components.</p><p>NAKIVO Backup &amp; Replication can be installed on Windows and Linux, or deployed as a pre-configured Virtual Appliance. The core of the product is written in (cross-platform) Java. Free and trial versions of the software can be obtained from the vendor website <a href="https://www.nakivo.com/resources/download/trial-download/">https://www.nakivo.com/resources/download/trial-download/</a>. The issues discussed in this advisory relate to the Linux version (9.4.0.r43656) of the software.</p><h1>Lack of access control in NAKIVO Transporter (CVE-2020-15851)</h1><p>For details of the Transporter service see the vendor websites: <a href="https://www.nakivo.com/blog/nakivo-backup-replication-components-transporter/">https://www.nakivo.com/blog/nakivo-backup-replication-components-transporter/</a> and <a title="https://helpcenter.nakivo.com/display/NH/Transporter" href="https://helpcenter.nakivo.com/display/NH/Transporter">https://helpcenter.nakivo.com/display/NH/Transporter</a>.<br><br>In a default installation NAKIVO Backup &amp; Replication automatically backs up its own configuration, including all jobs, inventory, information about connected transporters, repositories, etc to a local unencrypted backup repository. It can be found in the following location "/opt/nakivo/repository". </p><p>The NAKIVO Transporter service does not implement any access or authentication controls. It is therefore possible to access unencrypted repositories without providing any credentials. Using the trial or free versions of the software readily available from the vendor website, it is a trivial task to exploit the issue.</p><h3> Exploitation steps</h3><ol>
<li>Install and configure a local Nakivo Backup &amp; Recovery Director instance.</li>
</ol><p class="p1"> <img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzYwMCwzMThd/1-install.jpg" alt="1 install" width="600" height="318"></p><p class="p1">2. Connect to the exposed Transporter service via the "Add Existing Transporter" step (a hostname and port is required).</p><p class="p1"><img class="leftAlone" title="" src="assets/Uploads/2-Addtransporter3.PNG" alt="2 Addtransporter3" width="474" height="423"></p><p class="p1">3. Connect to a remote backup repository via the "Add existing backup repository" option by choosing the transporter added in the previous step and providing the repository path (the default path is "/opt/nakivo/repository").</p><p class="ss-uploadfield-item-preview preview"><span><img class="leftAlone" title="" src="assets/Uploads/3-addrepo2.PNG" alt="3 addrepo2" width="486" height="299"> </span></p><p class="ss-uploadfield-item-preview preview">4. If the repository contains a Director configuration backup it will be automatically imported.</p><p><span class="s1"><img class="leftAlone" title="" src="assets/Uploads/4-Selfbackup.PNG" alt="4 Selfbackup" width="489" height="162"></span></p><p><span class="s1">5. Access to all unencrypted backup data existing in the configured repository path on the Transporter will also be possible.</span></p><p><span class="s1"><img class="leftAlone" title="" src="assets/Uploads/5-restore.PNG" alt="5 restore" width="563" height="460"></span></p><p><span class="s1">6. Imported configuration data may contain passwords to other encrypted repositories configured on the Director.</span> </p><h3 class="p1"><span class="s1">Detection</span></h3><p class="p1"><span class="s1">Default installations use a self signed NAKIVO TLS/SSL certificate. The Common Name is "<span>NAKIVO Backup &amp; Replication Transporter".</span></span></p><pre class="p1"><span class="s1">% ncat --ssl -v 192.168.86.237 9446<br></span><span class="s1">Ncat: Version 7.80 ( https://nmap.org/ncat )<br></span><span class="s1">Ncat: Subject: C=US, CN=NAKIVO Backup &amp; Replication Transporter<br></span><span class="s1">Ncat: Issuer: C=US, CN=NAKIVO Backup &amp; Replication Transporter<br></span><span class="s1">Ncat: SHA-1 fingerprint: 2552 FF72 9529 5F26 C901 42F4 56EE D580 2767 C0AA<br></span><span class="s1">Ncat: Certificate verification failed (self signed certificate).<br></span><span class="s1">Ncat: SSL connection to 192.168.86.237:9446.<br></span><span class="s1">Ncat: SHA-1 fingerprint: 2552 FF72 9529 5F26 C901 42F4 56EE D580 2767 C0AA<br></span><span class="s1">^C</span></pre><p class="p1"><span class="s1"><span class="s1">The F-Secure Hibiki service, which is similar to Shodan, was used to identify exposed Transporter and Director interfaces. By analysing SSL certificate common names a</span></span><span class="s1"><span class="s1">pprox. 1k hosts found on the internet exposing the NAKIVO Transporter service and of those, 278 hosts were also exposing the Director service. Shodan queries identified little to no exposed systems:</span></span></p><p><a href="https://www.shodan.io/search?query=ssl%3A%22NAKIVO%22+port%3A%229446%22">https://www.shodan.io/search?query=ssl%3A%22NAKIVO%22+port%3A%229446%22</a></p><p><a href="https://www.shodan.io/search?query=ssl%3A%22NAKIVO+Backup+%26+Replication+Transporter%22">https://www.shodan.io/search?query=ssl%3A%22NAKIVO+Backup+%26+Replication+Transporter%22</a></p><p>Many systems appear to be home users who have presumably accidentally exposed their NAS to the internet. However, if the vendor marketing and boasts are to be believed; the solution is also popular with enterprises also.</p><p>A PoC scanner is below and can be used to identify potentially vulnerable transporter services. The scanner sends a 'PING' to the Transporter service:</p><pre class="p1"><span class="s1">import ssl, socket, sys, getopt, re<br>import M2Crypto, OpenSSL<br>context = ssl.SSLContext(ssl.PROTOCOL_TLSv1_2)<br>context.verify_mode = ssl.CERT_NONE<br>def main(argv):<br>  inputfile = ''<br>  port = 9446<br>  try:<br>   opts, args = getopt.getopt(argv,"hi:",["ifile="])<br>  except getopt.GetoptError:<br>   print 'scanner.py -i &lt;inputfile&gt;'<br>   sys.exit(2)<br>  for opt, arg in opts:<br>   if opt == '-h':<br>     print 'scanner.py -i &lt;inputfile&gt;'<br>     sys.exit()<br>   elif opt in ("-i", "--ifile"):<br>     inputfile = arg<br>   f=open(inputfile, "r")    <br>   hosts = f.read().split('\n')<br>   for host in hosts:<br>    if host != "":<br>     s = context.wrap_socket(socket.socket(socket.AF_INET), server_hostname=host)<br>     try:<br>      cert = ssl.get_server_certificate((host,port))<br>      x509 = M2Crypto.X509.load_cert_string(cert)<br>      CN = x509.get_subject().as_text()<br>      if re.search("CN=NAKIVO",CN): <br>       s.connect((host, port))<br>       ping = '280a2430383061303363332d366465662d346433382d383564362d3163336234373035653733341000'.decode('hex')<br>       s.send(ping)<br>       data=s.recv(1024)<br>       pattern = "\x10\x03\x72"<br>       regex = re.compile(pattern)<br>       for match_obj in regex.finditer(data):<br>        offset = match_obj.start()<br>        ver_len = ord(data[offset+3:offset+4])<br>        print '[x] host:',host,'port:',port,'version:',data[offset+4:offset+4+ver_len]<br>     except socket.error:<br>       print "[!] failed to connect to:",host,"port:",port<br>if __name__ == "__main__":<br>  main(sys.argv[1:])<br></span></pre><p>Nakivo uses protobuf messages with length prefix framing. Since no proto files were available the NCC Group BlackBox Protobuf (<a href="https://github.com/nccgroup/blackboxprotobuf">https://github.com/nccgroup/blackboxprotobuf</a>) Python library was used to analyse the Transporter communications.</p><p>The Java source file com/nakivo/nbr/controller/remote/protocol/PrimaryProtocolExtender.java contains the command code mappings.</p><p>The following message issues a PING command. The command code for Ping is 0.</p><pre>{<br>  "1": "080a03c3-6def-4d38-85d6-1c3b4705e734",<br>  "2": 0<br>}</pre><p class="p1"><span class="s1">The response is processed and the version string is  extracted by the scanner. <br></span></p><pre>{<br>  "15": "071C0986-1FA3-EDCC-66CC-9533D4BBDE80",<br>  "14": "9.2.1.r40930",<br>  "19": "56 4d 99 8f 67 66 56 e5-26 6f 99 68 e8 c1 33 35",<br>  "18": [<br>    2,<br>    3,<br>    &lt;CUT&gt;<br>    25,<br>    18<br>  ],<br>  "1": "27d9024a-632d-4f1b-9024-1c58a76500dd",<br>  "2": 3<br>}</pre><h3> Impact</h3><ul>
<li>Read / modify unencrypted backup repositories.</li>
<li>Create new backup repositories in any path writable to the Nakivo Transporter process.</li>
<li>Import the Nakivo Director configuration backup saved to unencrypted repositories.</li>
<li>Nakivo Director configuration backup contains encrypted credentials for hosts which are being backed up (SSH, AWS keys, VSphere, RDP, etc.), hashes of the web interface passwords and passwords to encrypted repositories. The encryption/decryption key is included in the backup.</li>
</ul><h3>Note</h3><p>This vulnerability does not impact the Transporter service installed on physical hosts as a backup agent. In this configuration the Transporter service requests need to be signed with a pre-shared transporter key.</p><h3>Workaround</h3><p>Do not expose the transporter service to public networks. Restrict access from controlled and trusted management networks. Encrypt all backup repositories including the default one.</p><p>Consider the security specific implementation and configuration advice presented in the vendors guidance <a href="https://helpcenter.nakivo.com/display/KB/Security+Considerations">https://helpcenter.nakivo.com/display/KB/Security+Considerations</a>.</p><h3>Remediation</h3><p>Apply the patch or fix from the vendor when it is available.</p><h1>Local privilege escalation in Nakivo Director on Linux (CVE-2020-15850)</h1><p>For details of the NAKIVO Director see the vendor website <a title="https://helpcenter.nakivo.com/display/NH/Director" href="https://helpcenter.nakivo.com/display/NH/Director">https://helpcenter.nakivo.com/display/NH/Director</a>.</p><p>The NAKIVO Director service runs with root privileges and does not restrict access to configuration files.<span><br></span></p><h3>Exploitation steps</h3><ol>
<li>Copy the configuration database.</li>
<li>Extract valid logins.</li>
<li>Connect to the controller web interface: https://localhost:4443</li>
<li>Initiate a password recovery for the extracted login.</li>
<li>Read the recovery key from configuration file readable for all local users and login.</li>
<li>Create a new backup job, in "Options" select "Run local pre job script", give path to a script controlled by the local user.</li>
<li>Run the job. User script will be executed with root privileges.</li>
</ol><pre>$ cp /opt/nakivo/director/userdata/db/product01.h2.db /tmp <br>$ java -classpath /opt/nakivo/director/libs/h2-1.4.196.jar \<br>org.h2.tools.Shell -url jdbc:h2:/tmp/product01 \<br>-sql "SELECT login FROM users WHERE login !='guest' and login !='8A9E9ED63750271B0137502757F80001';"<br>$ cat /opt/nakivo/director/forgot_password.txt</pre><p><a href="https://www.shodan.io/search?query=ssl%3A%22NAKIVO%22+port%3A%224443%22">https://www.shodan.io/search?query=ssl%3A%22NAKIVO%22+port%3A%224443%22</a></p><h3>Impact</h3><p>A local Linux user can gain access to Nakivo Director web interface and elevate his privileges to root.</p><h3>Workaround</h3><p>Consider the security specific implementation and configuration advice presented in the vendors guidance <a href="https://helpcenter.nakivo.com/display/KB/Security+Considerations">https://helpcenter.nakivo.com/display/KB/Security+Considerations</a>.</p><p>Remove unnecessary permissions from the Nakivo Director directory in order to protect the configuration data.</p><pre>chmod o-rx /opt/nakivo/director</pre><p><strong>Version 10.3 Update:</strong> This version has the CVE-2020-15850 fixed and has added the Transporter password option. In order to protect against the CVE-2020-15851 configure the strong transporter password as described in Nakivo<br>documentation: <a href="https://helpcenter.nakivo.com/display/NH/Installing+on+Linux#InstallingonLinux-TransporterInstallation">https://helpcenter.nakivo.com/display/NH/Installing+on+Linux#InstallingonLinux-TransporterInstallation</a></p><h2>Credits</h2><p>These issues were found by Łukasz Czarniecki.</p><h2>Timeline</h2><table>
<thead>
<tr>
<td>Date</td>
<td>Summary</td>
</tr>
</thead>
<tbody>
<tr>
<td>14/04/2020</td>
<td>F-Secure makes initial contact with the vendor</td>
</tr>
<tr>
<td>23/04/2020</td>
<td>F-Secure delivers the advisory to Nakivo</td>
</tr>
<tr>
<td><span>10/06/2020</span></td>
<td><span>Nakivo advises that they propose to address the issues in an upcoming release (10.2)</span></td>
</tr>
<tr>
<td><span>10/06/2020</span></td>
<td><span>F-Secure requests an update on the intended release date for version 10.2</span></td>
</tr>
<tr>
<td><span>16/06/2020</span></td>
<td><span>Nakivo advises that version 10.2 is scheduled for release in October 2020</span></td>
</tr>
<tr>
<td><span><span>17/09/2020</span></span></td>
<td><span><span>F-Secure advises Nakivo of intended publication date of advisory</span></span></td>
</tr>
<tr>
<td><span>21/09/2020</span></td>
<td><span>F-Secure release the advisory</span></td>
</tr>
<tr>
<td><span>04/05/2021</span></td>
<td><span>Issues fixed in v10.3</span></td>
</tr>
</tbody>
</table><p> </p><p> </p><p> </p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/nakivo-backup-and-replication-multiple-vulnerabilities/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/nakivo-backup-and-replication-multiple-vulnerabilities/&text=Nakivo Backup &amp; Replication - Multiple vulnerabilities" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/nakivo-backup-and-replication-multiple-vulnerabilities/&title=Nakivo Backup &amp; Replication - Multiple vulnerabilities" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/nakivo-backup-and-replication-multiple-vulnerabilities/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
