<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Apache ActiveMQ LDAP Wildcard Interpretation</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/apache-activemq-ldap-wildcard-interpretation/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/apache-activemq-ldap-wildcard-interpretation/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/apache-activemq-ldap-wildcard-interpretation/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Apache ActiveMQ LDAP Wildcard Interpretation</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Apache ActiveMQ LDAP</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2014-3612</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>LDAP Wildcard Interpretation</td>
          </tr>
        </table>
        
        <p>Two weaknesses were identified in the way Apache ActiveMQ performs <span class="caps">LDAP</span> authentication.</p>
<p>The advisory can be downloaded <a href="system/assets/883/original/Apache_ActiveMQ_LDAP_Wildcard_Interpretation.pdf">here</a>.</p>
<h3>Description:</h3>
<p>Apache ActiveMQ is an open source message-oriented middleware messaging broker. ActiveMQ supports various message queueing protocols, such as Message Queue Telemetry Transport (<span class="caps">MQTT</span>), Advanced Message Queuing Protocol (<span class="caps">AMQP</span>), and Streaming Text Oriented Messaging Protocol (<span class="caps">STOMP</span>).</p>
<p>Two vulnerabilities were identified in the way Apache ActiveMQ handles client credentials when performing authentication with an <span class="caps">LDAP</span> server.</p>
<p>Apache ActiveMQ versions 5.0.0 to 5.10.0 were found to be affected by these weaknesses.</p>
<h3>Impact:</h3>
<p>The vulnerabilities allow for leveraging the unauthenticated authentication mechanism, when supported by the remote <span class="caps">LDAP</span> service, or abuse an <span class="caps">LDAP</span> wildcard expansion weakness. The unauthenticated authentication mechanism, as specified in <span class="caps">RFC</span> 4513, may be used for performing unauthenticated Bind with an <span class="caps">LDAP</span> service. The wildcard interpretation weakness allows for brute forcing a password, for an unknown but valid account, as opposed to brute forcing a combination of username and password.</p>
<h3>Cause:</h3>
<p>ActiveMQ was found to lack input sanitisation of the submitted client credentials before using them to authenticate with an external <span class="caps">LDAP</span> server.</p>
<h3>Interim Workaround:</h3>
<p>The unauthenticated authentication mechanism vulnerability can be mitigated by disabling the respective mechanism on the <span class="caps">LDAP</span> server.</p>
<h3>Solution:</h3>
<p>Upgrade to Apache ActiveMQ version 5.11.0 or later.</p>
<h3>Technical details:</h3>
<p>Apache ActiveMQ provides pluggable security through various different providers. One of these providers is the ActiveMQ Java Authentication and Authorization Service (<span class="caps">JAAS</span>).</p>
<p>The <span class="caps">LDAP</span> authentication module, as implemented in ActiveMQ <span class="caps">JAAS</span>, was found to allow the unauthenticated authentication mechanism as specified in <span class="caps">RFC</span> 4513, when the latter is supported and enabled on the <span class="caps">LDAP</span> server. This mechanism allows for establishing an anonymous authorisation state by sending an <span class="caps">LDAP</span> Bind request with a valid non-zero length username and an empty password.</p>
<p>The security fix applied by Apache includes the following checks for non-null usernames and passwords before attempting to authenticate with the <span class="caps">LDAP</span> Server.</p>
<pre>diff -u -N -re1bbde7302d7d169bec978633d2dd85eba2e19cc -r0b5231ada5ce365b41832ba8752ee210145d1cbe
--- activemq-broker/src/main/java/org/apache/activemq/network/LdapNetworkConnector.java
	(.../LdapNetworkConnector.java)	(revision e1bbde7302d7d169bec978633d2dd85eba2e19cc)
+++ activemq-broker/src/main/java/org/apache/activemq/network/LdapNetworkConnector.java
	(.../LdapNetworkConnector.java)	(revision 0b5231ada5ce365b41832ba8752ee210145d1cbe)
@@ -210,8 +210,16 @@
             env.put(Context.SECURITY_AUTHENTICATION, "none");
         } else {
             LOG.debug("    login credentials [{}:******]", user);
-            env.put(Context.SECURITY_PRINCIPAL, user);
-            env.put(Context.SECURITY_CREDENTIALS, password);
+            if (user != null &amp;&amp; !"".equals(user)) {
+                env.put(Context.SECURITY_PRINCIPAL, user);
+            } else {
+                throw new Exception("Empty username is not allowed");
+            }
+            if (password != null &amp;&amp; !"".equals(password)) {
+                env.put(Context.SECURITY_CREDENTIALS, password);
+            } else {
+                throw new Exception("Empty password is not allowed");
+            }
         }
         boolean isConnected = false;
         while (!isConnected) {</pre>
<p>Another vulnerability was related to lack of input sanitisation when processing usernames supplied by MQ clients.</p>
<p>When <span class="caps">LDAP</span> authentication is enabled, it is possible for an attacker to supply an <span class="caps">LDAP</span> wildcard character instead of a valid username. The wildcard, when processed by the <span class="caps">LDAP</span> server, will be matched against a valid username. This allows an adversary to brute force a password for an unknown but valid account as opposed to brute forcing a combination of username and password. Once a valid password is found, the attacker can successfully authenticate with <span class="caps">LDAP</span> and publish/subscribe to a queue.</p>
<p>The vulnerability lies in the ActiveMQ implementation of the ‘Find and Bind’ <span class="caps">LDAP</span> authentication mode.</p>
<p>ActiveMQ takes the username supplied by a client and uses it to construct a search filter. <span class="caps">LDAP</span> search is then performed starting at a pre-configured base Distinguished Name (DN) and looking for the user DN. When a match is found, the returned DN is subsequently used for an <span class="caps">LDAP</span> Bind with a client provided password. When the initial search is performed using an <span class="caps">LDAP</span> wildcard, a list of all currently configured users is returned in response. In this case, ActiveMQ will process the first element of the list, extract its DN and proceed with a Bind attempt.</p>
<p>The fix applied by Apache escapes characters with special meaning before performing the initial user DN search.</p>
<pre>diff -u -N -r20747eedca6577af2031c107d4b1ec3b69724731 -r0b5231ada5ce365b41832ba8752ee210145d1cbe
--- activemq-jaas/src/main/java/org/apache/activemq/jaas/LDAPLoginModule.java
	(.../LDAPLoginModule.java)	(revision 20747eedca6577af2031c107d4b1ec3b69724731)
+++ activemq-jaas/src/main/java/org/apache/activemq/jaas/LDAPLoginModule.java
	(.../LDAPLoginModule.java)	(revision 0b5231ada5ce365b41832ba8752ee210145d1cbe)
@@ -190,7 +190,7 @@
         try {
 
             String filter = userSearchMatchingFormat.format(new String[] {
-                username
+                doRFC2254Encoding(username)
             });
             SearchControls constraints = new SearchControls();
             if (userSearchSubtreeBool) {
@@ -319,7 +319,7 @@
             return list;
         }
         String filter = roleSearchMatchingFormat.format(new String[] {
-            doRFC2254Encoding(dn), username
+            doRFC2254Encoding(dn), doRFC2254Encoding(username)
         });
 
         SearchControls constraints = new SearchControls();
@@ -459,9 +459,14 @@
             env.put(Context.INITIAL_CONTEXT_FACTORY, getLDAPPropertyValue(INITIAL_CONTEXT_FACTORY));
             if (isLoginPropertySet(CONNECTION_USERNAME)) {
                 env.put(Context.SECURITY_PRINCIPAL, getLDAPPropertyValue(CONNECTION_USERNAME));
+            } else {
+                throw new NamingException("Empty username is not allowed");
             }
+
             if (isLoginPropertySet(CONNECTION_PASSWORD)) {
                 env.put(Context.SECURITY_CREDENTIALS, getLDAPPropertyValue(CONNECTION_PASSWORD));
+            } else {
+                throw new NamingException("Empty password is not allowed");
             }
             env.put(Context.SECURITY_PROTOCOL, getLDAPPropertyValue(CONNECTION_PROTOCOL));
             env.put(Context.PROVIDER_URL, getLDAPPropertyValue(CONNECTION_URL));
@@ -484,7 +489,7 @@
     
     private boolean isLoginPropertySet(String propertyName) {
     	for (int i=0; i &lt; config.length; i++ ) {
-    		if (config[i].getPropertyName() == propertyName &amp;&amp; config[i].getPropertyValue() != null)
+    		if (config[i].getPropertyName() == propertyName &amp;&amp; 
                   (config[i].getPropertyValue() != null &amp;&amp; !"".equals(config[i].getPropertyValue())))
     				return true;
     	}
     	return false;</pre>
<h3>Detailed Timeline</h3>
<table><tbody><tr><td>Date</td>
<td>Summary</td>
</tr><tr><td>13/08/2014</td>
<td>Reported to Apache</td>
</tr><tr><td>13/08/2014</td>
<td>Apache confirms reception</td>
</tr><tr><td>26/08/2014</td>
<td>Apache requests a proof of concept</td>
</tr><tr><td>26/08/2014</td>
<td><span class="caps">MWR</span> provides a proof of concept</td>
</tr><tr><td>08/09/2014</td>
<td>Apache suggests fix</td>
</tr><tr><td>05/02/2015</td>
<td>Public fix released</td>
</tr><tr><td>06/03/2015</td>
<td>Advisory published</td>
</tr></tbody></table>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/apache-activemq-ldap-wildcard-interpretation/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/apache-activemq-ldap-wildcard-interpretation/&text=Apache ActiveMQ LDAP Wildcard Interpretation" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/apache-activemq-ldap-wildcard-interpretation/&title=Apache ActiveMQ LDAP Wildcard Interpretation" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      
      <a href="/assets/BlogFiles/Apache-ActiveMQ-LDAP-Wildcard-Interpretation.pdf" class="flex-container__box">
            <span class="content-type">Download</span>
            
            <h3 class="flex-container__box-title">Download the advisory here.</h3>
            
      </a>
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/apache-activemq-ldap-wildcard-interpretation/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
