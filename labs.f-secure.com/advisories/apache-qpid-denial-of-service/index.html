<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Apache Qpid Denial of Service</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/apache-qpid-denial-of-service/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/apache-qpid-denial-of-service/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/apache-qpid-denial-of-service/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Apache Qpid Denial of Service</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Apache Qpid</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Apache Qpid Denial of Service</td>
          </tr>
        </table>
        
        <p>The Apace Qpid messaging broker is susceptible to several denial of service conditions when handling malformed, unsupported or unexpected <span class="caps">AMQP</span> packets.</p>
<p>The advisory can be downloaded <a href="system/assets/860/original/Apache_Qpid_Denial_of_Service.pdf">here</a>.</p>
<h3>Description</h3>
<p>Apache Qpid is an open source message-oriented middleware messaging broker. Qpid provides Java and C++ implementations of the Advanced Message Queuing Protocol (<span class="caps">AMQP</span>).</p>
<p>The C++ broker implementation is susceptible to several denial of service conditions caused by mishandling of invalid or unsupported <span class="caps">AMQP</span> packets.</p>
<h3>Impact</h3>
<p>Three distinct bugs allow for an unauthenticated adversary to crash the broker process, thus causing a denial of service and preventing legitimate users from exchanging messages.</p>
<h3>Cause</h3>
<p>Apache Qpid performs incomplete and insufficient sanity checks on incoming <span class="caps">AMQP</span> packets.</p>
<h3>Interim Workaround</h3>
<p>Apache has developed a patch that can be manually applied to Qpid 0.30. This patch is available under the following link: <a href="https://issues.apache.org/jira/browse/QPID-6310">https://issues.apache.org/jira/browse/<span class="caps">QPID</span>-6310</a></p>
<h3>Solution</h3>
<p>Upgrade to Apache Qpid version 0.31 or later.</p>
<h3>Technical Details</h3>
<p>Three distinct denial of service conditions were identified in the way Qpid handles malformed, unsupported or unexpected <span class="caps">AMQP</span> packets.</p>
<p>The <span class="caps">AMQP</span> 0-10 specification allows for certain commands and controls to transfer additional segments, namely header and body segments that can be used for carrying message content.</p>
<p>Apache Qpid handles additional segments only for the <span class="caps">AMQP</span> message-transfer command. Any other command that includes header and/or body segments would cause a segmentation fault in the broker process due to an out-of-bounds read condition. This will cause the broker process to exit.</p>
<p>The following patch was developed to discard frames with additional segments, unless the specified <span class="caps">AMQP</span> command is message-transfer.</p>
<pre>diff --git a/qpid/cpp/src/qpid/broker/MessageBuilder.cpp b/qpid/cpp/src/qpid/broker/MessageBuilder.cpp
index 7cb9951..f5e9332 100644
--- a/qpid/cpp/src/qpid/broker/MessageBuilder.cpp
+++ b/qpid/cpp/src/qpid/broker/MessageBuilder.cpp
@@ -45,6 +45,9 @@ void MessageBuilder::handle(AMQFrame&amp; frame)
     switch(state) {
     case METHOD:
         checkType(METHOD_BODY, type);
+        if (!frame.getMethod()-&gt;isA&lt;qpid::framing::MessageTransferBody&gt;())
+            throw NotImplementedException(QPID_MSG("Unexpected method: " &lt;&lt; *(frame.getMethod())));
+
         exchange = frame.castBody&lt;qpid::framing::MessageTransferBody&gt;()-&gt;getDestination();
         state = HEADER;
         break;</pre>
<p>Another vulnerability relates to the way Apache Qpid handles out-of-session <span class="caps">AMQP</span> controls.</p>
<p>The <span class="caps">AMQP</span> 0-10 specification defines two distinct data units, namely commands and controls, that can be transferred in <span class="caps">AMQP</span>. Commands can only be sent on established sessions, while there is no such requirement for the controls.</p>
<p>One of the <span class="caps">AMQP</span> defined controls is session-gap. This control is not supported by Qpid and an appropriate error message is returned to a client when such a control is received on an established session. However, the session-gap control is not properly handled when requested before a session is opened, which triggers an assert statement and causes the process to exit.</p>
<p>The vendor fix was to check whether this control is received out-of-session, discard the <span class="caps">AMQP</span> frame and notify the client.</p>
<pre>diff --git a/qpid/cpp/src/qpid/amqp_0_10/SessionHandler.cpp b/qpid/cpp/src/qpid/amqp_0_10/SessionHandler.cpp
index 43f39c2..bd0dcbf 100644
--- a/qpid/cpp/src/qpid/amqp_0_10/SessionHandler.cpp
+++ b/qpid/cpp/src/qpid/amqp_0_10/SessionHandler.cpp
@@ -276,6 +276,7 @@ void SessionHandler::flush(bool expected, bool confirmed, bool completed) {
 }
 
 void SessionHandler::gap(const SequenceSet&amp; /*commands*/) {
+    checkAttached();
     throw NotImplementedException("session.gap not supported");
 }</pre>
<p>Another flaw was found in the way Apache Qpid handles <span class="caps">AMQP</span> sequence-set variables.</p>
<p>The <span class="caps">AMQP</span> 0-10 specification defines the variable width sequence-set type. According to the <span class="caps">AMQP</span> standard, the sequence-set type is a set of pairs of <span class="caps">RFC</span>-1982 numbers representing a discontinuous range within an <span class="caps">RFC</span>-1982 sequence. Each pair represents a closed interval within the list. The messaging broker service can be crashed when handling a sequence-set which contains a pair, also referred to as a range, where the range expressed is the maximum possible one. This would trigger an assert statement which will cause the process to exit.</p>
<p>The following patch resolves the vulnerability and supersedes an incomplete fix related to <span class="caps">CVE</span>-2015-0203.</p>
<pre>diff --git a/qpid/cpp/src/qpid/framing/SequenceSet.cpp b/qpid/cpp/src/qpid/framing/SequenceSet.cpp
index 845bf8b..6510842 100644
--- a/qpid/cpp/src/qpid/framing/SequenceSet.cpp
+++ b/qpid/cpp/src/qpid/framing/SequenceSet.cpp
@@ -33,7 +33,18 @@ namespace framing {
 
 namespace {
 //each range contains 2 numbers, 4 bytes each
-uint16_t RANGE_SIZE = 2 * 4; 
+uint16_t RANGE_SIZE = 2 * 4;
+int32_t MAX_RANGE = 2147483647;//2^31-1
+
+int32_t gap(const SequenceNumber&amp; a, const SequenceNumber&amp; b)
+{
+    return a &lt; b ? b - a : a - b;
+}
+
+bool is_max_range(const SequenceNumber&amp; a, const SequenceNumber&amp; b)
+{
+    return gap(a, b) == MAX_RANGE;
+}
 }
 
 void SequenceSet::encode(Buffer&amp; buffer) const
@@ -58,7 +69,17 @@ void SequenceSet::decode(Buffer&amp; buffer)
         SequenceNumber b(buffer.getLong());
         if (b &lt; a)
             throw IllegalArgumentException(QPID_MSG("Invalid range in sequence set: " &lt;&lt; a &lt;&lt; " -&gt; " &lt;&lt; b));
-        add(a, b);
+        if (is_max_range(a, b)) {
+            //RangeSet holds 'half-closed' ranges, where the end is
+            //one past the 'highest' value in the range. So if the
+            //range is already the maximum expressable with a 32bit
+            //sequence number, we can't represent it as a
+            //'half-closed' range, so we represent it as two ranges.
+            add(a, b-1);
+            add(b);
+        } else {
+            add(a, b);
+        }
     }
 }</pre>
<h3>Detailed Timeline</h3>
<table><tbody><tr><td>Date</td>
<td>Summary</td>
</tr><tr><td>2014-12-22</td>
<td>Reported to Apache and Red Hat</td>
</tr><tr><td>2014-12-23</td>
<td>Apache confirms reception</td>
</tr><tr><td>2015-01-07</td>
<td>Red Hat suggests fix</td>
</tr><tr><td>2015-01-12</td>
<td><span class="caps">MWR</span> acknowledges fix</td>
</tr><tr><td>2015-01-13</td>
<td>Public fix released</td>
</tr><tr><td>2015-01-18</td>
<td><span class="caps">MWR</span> notifies the vendor of fix and advisory inconsistencies</td>
</tr><tr><td>2015-01-19</td>
<td>Red Hat confirms inconsistencies</td>
</tr><tr><td>2015-01-23</td>
<td>Red Hat suggests new fix</td>
</tr><tr><td>2015-01-26</td>
<td>Public fix released</td>
</tr><tr><td>2015-02-06</td>
<td>Advisory published</td>
</tr></tbody></table>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/apache-qpid-denial-of-service/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/apache-qpid-denial-of-service/&text=Apache Qpid Denial of Service" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/apache-qpid-denial-of-service/&title=Apache Qpid Denial of Service" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      
      <a href="/assets/advisoriesApache-Qpid-Denial-of-Service.pdf" class="flex-container__box">
            <span class="content-type">Download</span>
            
            <h3 class="flex-container__box-title">Download the advisory here.</h3>
            
      </a>
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/apache-qpid-denial-of-service/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
