<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="x-subsite-id" content="1" />

    <title>Citrix Virtual Apps and Desktops 7 - Local Privilege Escalation</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/citrix-virtual-apps-and-desktops-7-unquoted-service-path/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/citrix-virtual-apps-and-desktops-7-unquoted-service-path/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/citrix-virtual-apps-and-desktops-7-unquoted-service-path/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Citrix Virtual Apps and Desktops 7 - Local Privilege Escalation</h1>
      
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Citrix Virtual Apps and Desktops 7 2006 and earlier, Citrix Virtual Apps and Desktops 1912 LTSR and earlier, Citrix XenApp / XenDesktop 7.15 LTSR and earlier, Citrix XenApp / XenDesktop 7.6 LTSR and earlier</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>Low</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2020-8269</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Local Privilege Escalation</td>
          </tr>
        </table>
        
        <h1>Description</h1><p><strong>Citrix Virtual Apps and Desktops 7</strong> (<a href="https://docs.citrix.com/en-us/citrix-virtual-apps-desktops-service.html">https://docs.citrix.com/en-us/citrix-virtual-apps-desktops-service.html</a>) is a set of services used to deliver and manage Citrix applications and virtual desktop instances. Included in Citrix Virtual Apps and Desktops 7 is the <strong>Citrix App Layering Guest Service</strong> service for Microsoft Windows, which allows independent components of a virtual machine to be assigned, patched and updated. These components include the Windows system itself, applications, and user settings/data.</p><p>The <strong>Citrix App Layering Service</strong> service is initiated as a Windows system service, which executes the <strong>C</strong><span><strong>:\Program Files\Unidesk\Uniservice\UniService.exe</strong> binary when an account authenticates to the Citrix instance. This service is executed by the high-privilege <strong>LocalSystem</strong> (NT AUTHORITY\SYSTEM) account.<br></span></p><p>F-Secure discovered that the service referenced this binary without quotations. If a vulnerable system is also configured with insecure filesystem permissions, a threat actor could hijack the service's execution, by placing an executable in the root <strong>C:\</strong> directory. This binary would then be executed with <span>NT AUTHORITY\SYSTEM</span> privileges.</p><h1>Impact</h1><p>Threat actors with user-level access to a Citrix virtual desktop instance, running Microsoft Windows configured with insecure filesystem permissions, could execute arbitrary PE files with <span>NT AUTHORITY\SYSTEM</span> privileges by hijacking the execution of the <strong>Citrix App Layering Guest Service</strong>.</p><h1>Remediation</h1><p>It is recommended to follow the vendor's remedial advice and upgrade to Citrix Virtual Apps and Desktops 7 version 2009 and above. Alternatively, hotfixes for specific Citrix Virtual Apps and Desktops/XenDesktop software versions can be obtained from the vendor's security update page. Note that this advisory also contains hotfixes for separate vulnerabilities which also affect the software, CVE-2020-8270 and CVE-2020-8283. A link to the vendor's security advisory is shown below:</p><ul>
<li><a title="https://support.citrix.com/article/CTX285059" href="https://support.citrix.com/article/CTX285059">https://support.citrix.com/article/CTX285059</a></li>
</ul><p>Additionally, it is recommended that Windows filesystem permissions should prevent non-administrative users from creating arbitrary binaries in the root <strong>C:\</strong> directory. Below are example <strong>C:\</strong> drive permissions on a default Windows 10 Enterprise 2016 LTSB installation (version 14393). These permissions prevent arbitrary binaries from being created in the root <strong>C:\</strong> directory.</p><pre>C:\&gt;icacls .<br> . BUILTIN\Administrators:(OI)(CI)(F)<br>   NT AUTHORITY\SYSTEM:(OI)(CI)(F)<br>   BUILTIN\Users:(OI)(CI)(RX)<br>  <strong> NT AUTHORITY\Authenticated Users:(OI)(CI)(IO)(M)</strong><br>   NT AUTHORITY\Authenticated Users:(AD)<br>   Mandatory Label\High Mandatory Level:(OI)(NP)(IO)(NW)<br> Successfully processed 1 files; Failed processing 0 files</pre><h1>Details</h1><p>The <strong>Citrix App Layering Guest Service</strong> references an unquoted service path. Observe the command output below, which shows the unquoted service path:</p><pre><span style="font-family: Courier New, Courier, monospace;">PS C:\Users\citrix_test\Desktop&gt; sc.exe qc UniService<br>[SC] QueryServiceConfig SUCCESS<br><br>SERVICE_NAME: UniService<br> TYPE : 10 WIN32_OWN_PROCESS<br> START_TYPE : 4 DISABLED<br> ERROR_CONTROL : 1 NORMAL<br><strong> BINARY_PATH_NAME : c:\Program Files\Unidesk\Uniservice\UniService.exe -R</strong><br> LOAD_ORDER_GROUP : Unidesk<br> TAG : 0<br> DISPLAY_NAME : Citrix App Layering Guest Service<br> DEPENDENCIES :<br> SERVICE_START_NAME : LocalSystem<br>PS C:\Users\citrix_test\Desktop&gt;</span></pre><p>This service path is referenced in the value for the H<strong>KLM\SYSTEM\CurrentControlSet\Services\Uniservice\ImagePath</strong> registry key, as shown in the screenshot below:</p><p><img class="leftAlone" style="display: block; margin-left: auto; margin-right: auto;" title="" src="assets/Uploads/_resampled/ResizedImageWzYwMCw0MDNd/uniservice.png" alt="uniservice" width="600" height="403"></p><p>This issue is only exploitable if non-standard NTFS permissions have been applied to the system's <strong>C:\</strong> directory. On modern Windows systems, default C:\ directory NTFS permissions prevent non-administrative accounts from being able to create new files in the root directory. However, this is not always the case in enterprise environments, especially for systems which are modified considerably from base installations due to the addition of software which may require non-standard file permissions to be applied.</p><p>If non-administrative users have the permission to create arbitrary binaries in the <strong>C:\</strong> directory, then an authenticated threat actor could create a program called "<strong>C:\program.exe</strong>" in the <strong>C:\</strong> drive. The next time a user logs into the Citrix virtual desktop instance, <strong>C:\program.exe</strong> will be executed in place of the binary referenced in the <strong>Citrix App Layering Guest Service</strong> with administrative privileges.</p><h1>Prerequisites</h1><ul>
<li>A Citrix virtual desktop instance running Microsoft Windows, configured with Citrix Virtual Apps and Desktops 7 version 2006 or below.<br><br></li>
<li>NTFS permissions allowing the creation of files (not directories) in the <strong>C:\</strong> drive, for non-administrative users.</li>
</ul><h1>Steps to reproduce</h1><ul>
<li>Create a binary in the <strong>C:\</strong> drive named <strong>program.exe</strong> on the Citrix virtual desktop instance. For demonstration purposes, the following C# code was compiled into a binary, which was copied to the the <strong>C:\</strong> drive and renamed <strong>program.exe</strong>. The code executes the <strong>whoami</strong> command and pipes the output to a text file in the example "citrix" user's directory. Make sure to adapt any file paths before compilation.</li>
</ul><pre>using System;<br>using System.Diagnostics;<br>public class Class1<br>{<br>    public static void Main(string[] args)<br>    {<br>       <br>        Process cmd = new Process();<br>        cmd.StartInfo.FileName = "cmd.exe";<br>        cmd.StartInfo.RedirectStandardInput = true;<br>        cmd.StartInfo.RedirectStandardOutput = true;<br>        cmd.StartInfo.CreateNoWindow = true;<br>        cmd.StartInfo.UseShellExecute = false;<br>        cmd.Start();<br><br>        cmd.StandardInput.WriteLine("whoami &gt; c:\\users\\citrix\\desktop\\test.txt");<br>        cmd.StandardInput.Flush();<br>        cmd.StandardInput.Close();<br>        cmd.WaitForExit();<br>        Console.WriteLine(cmd.StandardOutput.ReadToEnd());<br>        }<br> }</pre><ul>
<li>Reboot the virtual machine and then log into the machine using a valid Windows account.<br><br></li>
<li>Observe that <strong>program.exe</strong> has been executed in place of <strong>C:\Program Files\Unidesk\Uniservice\UniService.exe</strong> as shown below. A warning message may also be displayed if Windows detects the newly-created executable in the <strong>C:\</strong> directory, depending on the configuration of the Windows machine, however at this point the binary has already been executed:</li>
</ul><p><img class="leftAlone" style="display: block; margin-left: auto; margin-right: auto;" title="" src="assets/Uploads/_resampled/ResizedImageWzYwMCwzODdd/privesc-type-output.png" alt="privesc type output" width="600" height="387"></p><h1>Disclosure Timeline</h1><table>
<tbody>
<tr>
<td>Date</td>
<td>Summary</td>
</tr>
<tr>
<td>12/06/2020</td>
<td>Vulnerability discovered.</td>
</tr>
<tr>
<td>13/06/2020</td>
<td>F-Secure conducts further testing to confirm impact.</td>
</tr>
<tr>
<td>15/06/2020</td>
<td>Vendor notified of issue.</td>
</tr>
<tr>
<td>30/06/2020</td>
<td>Vendor validated issue and confirmed impact. Vendor agreed to inform F-Secure regarding patching time lines.</td>
</tr>
<tr>
<td>01/11/2020</td>
<td>Vendor provides disclosure date of 10/11/2020.</td>
</tr>
<tr>
<td>10/11/2020</td>
<td>Vendor releases official advisory and patches for affected software.</td>
</tr>
<tr>
<td>11/12/2020</td>
<td>F-Secure releases detailed advisory of issue.</td>
</tr>
</tbody>
</table><h1>References</h1><ul>
<li><a title="https://support.citrix.com/article/CTX285059" href="https://support.citrix.com/article/CTX285059" target="_blank">https://support.citrix.com/article/CTX285059</a></li>
<li><a title="https://ss64.com/nt/icacls.html" href="https://ss64.com/nt/icacls.html">https://ss64.com/nt/icacls.html</a></li>
<li><a title="https://www.stigviewer.com/stig/windows_10/2019-01-04/finding/V-63373" href="https://www.stigviewer.com/stig/windows_10/2019-01-04/finding/V-63373">https://www.stigviewer.com/stig/windows_10/2019-01-04/finding/V-63373</a></li>
<li><a title="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc753525(v=ws.10)" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc753525(v=ws.10)">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc753525(v=ws.10)</a></li>
<li><a title="https://www.thezdi.com/blog/2017/9/13/simple-to-find-simple-to-fix-locating-weak-file-permissions-in-advantech-webaccess" href="https://www.thezdi.com/blog/2017/9/13/simple-to-find-simple-to-fix-locating-weak-file-permissions-in-advantech-webaccess">https://www.thezdi.com/blog/2017/9/13/simple-to-find-simple-to-fix-locating-weak-file-permissions-in-advantech-webaccess</a></li>
</ul><p> </p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/citrix-virtual-apps-and-desktops-7-unquoted-service-path/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/citrix-virtual-apps-and-desktops-7-unquoted-service-path/&text=Citrix Virtual Apps and Desktops 7 - Local Privilege Escalation" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/citrix-virtual-apps-and-desktops-7-unquoted-service-path/&title=Citrix Virtual Apps and Desktops 7 - Local Privilege Escalation" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/citrix-virtual-apps-and-desktops-7-unquoted-service-path/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
